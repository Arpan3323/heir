<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.113.0"><link rel=canonical type=text/html href=https://heir.dev/docs/><link rel=alternate type=application/rss+xml href=https://heir.dev/docs/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Documentation | HEIR</title><meta name=description content><meta property="og:title" content="Documentation"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://heir.dev/docs/"><meta itemprop=name content="Documentation"><meta itemprop=description content><meta name=twitter:card content="summary"><meta name=twitter:title content="Documentation"><meta name=twitter:description content><link rel=preload href=/scss/main.min.dffc1689fd83830a5fb090d38ca9680587c322008ad97c675ee0ca22e5fb10d5.css as=style><link href=/scss/main.min.dffc1689fd83830a5fb090d38ca9680587c322008ad97c675ee0ca22e5fb10d5.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.3.min.js integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ==" crossorigin=anonymous></script>
<script>window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]]}}</script><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
<script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></head><body class=td-section><header><nav class="td-navbar navbar-dark js-navbar-scroll"><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="32" height="32" fill="#fff" fill-opacity=".01"/><path d="M18.6889 10.124l7.7916 5.0511 2.6263-1.6684-2.6146-1.6779-7.8033-4.96754 2.8526 1.84162L18.6889 10.124z" fill="#efcf6f"/><path d="M29.1185 6.86125 18.6979.13981 16.06 1.79876 26.4922 8.52025l2.6263-1.659z" fill="#efcf6f"/><path d="M8.2405 6.74134 5.60033 5.07291 3.05751 6.79935 5.67334 8.49344 8.2405 6.74134z" fill="#ee958a"/><path d="M10.8697 8.49344 8.2405 10.124v3.3995l5.2049-3.3348-2.5757-1.69526z" fill="#ee958a"/><path d="M5.67334 8.49344 3.05751 6.79935 3.03318 23.4932l2.64016 1.6897V8.49344z" fill="#a32e24"/><path d="M29.1185 6.86126 26.4922 8.52025V11.8288l2.6263-1.6401V6.86126z" fill="#d38041"/><path d="M21.5415 8.70288 18.6889 6.86126V10.124l2.8526-1.42112z" fill="#d38041"/><path fill-rule="evenodd" clip-rule="evenodd" d="M8.2405 6.74134V10.124v3.3995l5.2049-3.3348V3.58723l2.6145-1.7885L16.1123 11.8484V18.467l-2.6158 1.6181L13.4574 13.5235 10.849 15.1694 8.2405 16.8152v6.678L5.67334 25.1829V8.49344L8.2405 6.74134z" fill="#dd583b"/><path d="M13.4965 20.0851 13.4574 13.5235 10.849 15.1694 10.8077 18.467l2.6888 1.6181z" fill="#a32e24"/><path fill-rule="evenodd" clip-rule="evenodd" d="M13.4454 3.58723V10.1887L10.8697 8.49344 10.9293 1.79873l2.5161 1.7885z" fill="#a32e24"/><path d="M16.0599 1.79873 13.4454.13981 10.9293 1.79873l2.5161 1.7885 2.6145-1.7885z" fill="#ee958a"/><path d="M16.06 1.79876 16.0793 5.52165 16.1123 11.8484V18.467l2.5766-1.6518V13.4696 10.124 6.86126l7.8033 4.96754V8.52025L16.06 1.79876z" fill="#e5ad11"/><path d="M18.6889 16.8152 16.1123 18.467l10.3682 6.7159V21.8372l-7.7916-5.022z" fill="#e5ad11"/><path d="M26.4805 15.1751 18.6889 10.124v3.3456l2.7505 1.7641 5.0411 3.2333V15.1751z" fill="#e5ad11"/><path d="M29.1068 13.5067l-2.6263 1.6684V18.467l2.6263-1.6518V13.5067z" fill="#d48041"/><path d="M29.1185 20.0851l-2.638 1.7521v3.3457l2.6263-1.6897L29.1185 20.0851z" fill="#d48041"/><path fill-rule="evenodd" clip-rule="evenodd" d="M26.4805 21.8372l-7.7916-5.022 2.7505-1.5815 5.0411 3.2333 2.638 1.6181-2.638 1.7521z" fill="#efcf6f"/><path d="M18.6889 13.4696v3.3456l2.7505-1.5815-2.7505-1.7641z" fill="#d48041"/><path d="M20.1621 26.5165l-4.2015-2.7017-4.2015-2.7016L11.7108 23.8491l6.3384 4.0776 2.1129 1.3512V26.5165z" fill="#395aad"/><path d="M7.49852 23.8491v2.6674l8.41958 5.4439V29.2779L7.49852 23.8491z" fill="#276e3a"/><path d="M9.57951 22.4781l-2.08099 1.371 8.41958 5.4288 2.1311-1.3512-6.3384-4.0776-2.13129-1.371z" fill="#add284"/><path d="M24.3747 26.5165V23.8491L22.174 22.8377l-2.0054.9665 2.1815 1.3793 2.0246 1.333z" fill="#395aad"/><path d="M18.0492 19.7061l2.1194 1.431-2.048 1.3721-2.1698-1.3721 2.0984-1.431z" fill="#395aad"/><path fill-rule="evenodd" clip-rule="evenodd" d="M20.1621 18.4432l-2.0415-.596-2.1581.596-2.1017 1.3349-2.1017 1.3351 2.1012 1.3511 6.3018 4.0522 2.188-1.333-2.1815-1.3793 2.0054-.9665 2.2007 1.0114 2.0995-1.329-2.0811-1.4069L22.3501 21.1371l-.1752-1.4237L22.174 19.7061l-2.0119-1.2629zm-2.1129 1.2629 2.1194 1.431-2.048 1.3721-2.1698-1.3721 2.0984-1.431z" fill="#9ec4e0"/><path d="M26.4742 22.5201l-2.0995 1.329v2.6674l2.1289-1.3305L26.4742 22.5201z" fill="#4285f4"/><path d="M20.1621 26.5165v2.7614l2.188-1.3512V25.1835l-2.188 1.333z" fill="#4285f4"/><path d="M15.9181 29.2779v2.6825l2.1311-1.3708V27.9267l-2.1311 1.3512z" fill="#4e9c68"/></svg></span><span class=navbar-brand__name>HEIR</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class=nav-item><a class="nav-link active" href=/><span>Home</span></a></li><li class=nav-item><a class="nav-link active" href=/docs/><span>Docs</span></a></li><li class=nav-item><a class=nav-link href=/blog/><span>Blog</span></a></li><li class=nav-item><a class=nav-link href=/community/><span>Community</span></a></li><li class=nav-item><a class=nav-link href=https://github.com/google/heir/ target=_blank rel=noopener><span>GitHub</span></a></li></ul></div><div class="d-none d-lg-block"></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/>Return to the regular view of this page</a>.</p></div><h1 class=title>Documentation</h1><ul><li>1: <a href=#pg-a2e0f2893b70992c6087c2b17584ff57>Getting Started</a></li><li>2: <a href=#pg-05b7a8e562e0a482b29460c121776963>Contributing to HEIR</a></li><li>3: <a href=#pg-1bf07101845de6da98f1c948b82c5ce0>Development</a></li><li>4: <a href=#pg-e62e32c8f8aaa5c7325bea5a1b00e345>Tutorials and Talks</a></li><li>5: <a href=#pg-439f0d1f88fc52920f9828a37ce073a8>Design</a></li><ul><li>5.1: <a href=#pg-bddfea9d49299ca5edc4a07ea06fcc23>Data-oblivious Transformations</a></li><li>5.2: <a href=#pg-76ae4da46c68c5cd44ad0ecf5d69993f>Secret</a></li><li>5.3: <a href=#pg-05018faa55dd802660a3ea38b8f7fb69>SIMD Optimizations</a></li><li>5.4: <a href=#pg-cd22aa05be277ba6c2e2f8f083706b51>Optimizing relinearization</a></li></ul><li>6: <a href=#pg-db9ac78ce08367ea2b7db8c1412049b6>Pipelines</a></li><li>7: <a href=#pg-590f1588f601079eeacfc7cb11dc5115>Dialects</a></li><ul></ul><li>8: <a href=#pg-19aafd690c3a7edde7a9c3e1fbaf737f>Passes</a></li></ul><div class=content><p>This section is where the HEIR documentation lives.</p></div></div><div class=td-content><h1 id=pg-a2e0f2893b70992c6087c2b17584ff57>1 - Getting Started</h1><h2 id=getting-heir>Getting HEIR</h2><h3 id=using-a-pre-built-nightly-binary>Using a pre-built nightly binary</h3><p>HEIR releases a <a href=https://github.com/google/heir/releases/tag/nightly>nightly</a>
binary for Linux x86-64. This is intended for testing compiler passes and not
for production use.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wget https://github.com/google/heir/releases/download/nightly/heir-opt
</span></span><span style=display:flex><span>chmod +x heir-opt
</span></span><span style=display:flex><span>./heir-opt --help
</span></span></code></pre></div><p>Then you can run the examples below, replacing <code>bazel run //tools:heir-opt --</code>
with <code>./heir-opt</code>. HEIR also publishes <code>heir-translate</code> and <code>heir-lsp</code> in the
same way.</p><h3 id=running-the-nightly-binary-from-a-notebook>Running the nightly binary from a notebook</h3><p>We publish an ipython extension <a href=https://pypi.org/project/heir-play/>heir-play</a>
that can be used in Jupyter or Colab notebooks.</p><pre tabindex=0><code>%pip install heir-play
%load_ext heir_play
</code></pre><p>This will download the nightly release binaries to the system the notebook
server is running on, then:</p><pre tabindex=0><code>%%heir_opt --flag1 --flag2

# MLIR code here
</code></pre><p>Runs <code>heir-opt</code> with the given command line flags on the MLIR code in the cell.</p><p>A cell magic is also available for <code>heir-translate</code> as <code>%%heir_translate</code>.</p><h3 id=building-from-source>Building From Source</h3><h4 id=prerequisites>Prerequisites</h4><ul><li><a href=https://git-scm.com/>Git</a></li><li>A C++ compiler and linker (<a href=https://clang.llvm.org/>clang</a> and
<a href=https://lld.llvm.org/>lld</a> are recommended).</li><li>Bazel via <a href=https://github.com/bazelbuild/bazelisk>bazelisk</a>, or version
<code>>=5.5</code></li><li>See <a href=https://heir.dev/docs/development>Development</a> for additional
prerequisites for active development</li></ul><details><summary>Detailed Instructions</summary>
The first two requirements are frequently pre-installed
or can be installed via the system package manager.
For example, on Ubuntu, these can be installed with<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt-get update <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> sudo apt-get install clang lld
</span></span></code></pre></div><p>You can download the latest Bazelisk release, e.g., for linux-amd64 (see the
<a href=https://github.com/bazelbuild/bazelisk/releases/latest>Bazelisk Release Page</a>
for a list of available binaries):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wget -c https://github.com/bazelbuild/bazelisk/releases/latest/download/bazelisk-linux-amd64
</span></span><span style=display:flex><span>mv bazelisk-linux-amd64 bazel
</span></span><span style=display:flex><span>chmod +x bazel
</span></span></code></pre></div><p>You will then likely want to move <code>bazel</code> to a location on your PATH, or add its
location to your PATH, e.g.:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir ~/bin
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#39;export PATH=$PATH:~/bin&#39;</span> &gt;&gt; ~/.bashrc
</span></span><span style=display:flex><span>mv bazel ~/bin/bazel
</span></span></code></pre></div><p>Note that on linux systems, your OS user must <strong>not</strong> be <code>root</code> as bazel might
refuse to work if run as root.</p></details><h4 id=clone-and-build-the-project>Clone and build the project</h4><p>You can clone and build HEIR from the terminal as described below. Please see
<a href=https://heir.dev/docs/development>Development</a> for information on IDE
configuration if you want to use an IDE to build HEIR.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone git@github.com:google/heir.git <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87>cd</span> heir
</span></span><span style=display:flex><span>bazel build @heir//tools:heir-opt
</span></span></code></pre></div><p>Some passes in this repository require Yosys as a dependency
(<code>--yosys-optimizer</code>). If you would like to skip Yosys and ABC compilation to
speed up builds, use the following build setting:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bazel build --//:enable_yosys<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span> @heir//tools:heir-opt
</span></span></code></pre></div><h4 id=optional-run-the-tests>Optional: Run the tests</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bazel <span style=color:#204a87>test</span> @heir//...
</span></span></code></pre></div><p>Like above, run the following to skip tests that depend on Yosys:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bazel <span style=color:#204a87>test</span> --//:enable_yosys<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span> --test_tag_filters<span style=color:#ce5c00;font-weight:700>=</span>-yosys @heir//...
</span></span></code></pre></div><h2 id=using-heir>Using HEIR</h2><h3 id=run-the-dot-product-example>Run the <code>dot-product</code> example</h3><p>The <code>dot-product</code> program computes the dot product of two length-8 vectors of
16-bit integers (<code>i16</code> in MLIR parlance). This example will showcase the OpenFHE
backend by manually calling the relevant compiler passes and setting up a C++
harness to call into the HEIR-generated functions.</p><p>Note: other backends are similar, but the different backends are in varying
stages of development.</p><p>The input program is in <code>tests/Examples/openfhe/dot_product_8.mlir</code>. Support for
standard input languages like <code>C</code> and <code>C++</code> are currently experimental at best,
but eventually we would use an MLIR-based tool to convert an input language to
MLIR like in that file. The program is below:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@dot_product</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>},</span> <span style=color:#000>%arg1</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>})</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#204a87;font-weight:700>i16</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%c0</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>index</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%c0_si16</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> affine<span style=color:#000;font-weight:700>.</span>for <span style=color:#000>%arg2</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span> to <span style=color:#0000cf;font-weight:700>8</span> iter_args<span style=color:#000;font-weight:700>(</span><span style=color:#000>%iter</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>%c0_si16</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>.</span>extract <span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>.</span>extract <span style=color:#000>%arg1</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%3</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>muli <span style=color:#000>%1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%2</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%4</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%iter</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%3</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>    affine<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%4</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>For an introduction to MLIR syntax, see the
<a href=https://mlir.llvm.org/docs/LangRef/>official docs</a> or
<a href=https://www.jeremykun.com/2023/08/10/mlir-running-and-testing-a-lowering/>this blog post</a>.</p><p>Now we run the <code>heir-opt</code> command to optimize and compile the program.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bazel run //tools:heir-opt -- <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--mlir-to-bgv<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;ciphertext-degree=8&#39;</span><span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--scheme-to-openfhe<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;entry-function=dot_product&#39;</span>  <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span><span style=color:#000>$PWD</span>/tests/Examples/openfhe/dot_product_8.mlir &gt; output.mlir
</span></span></code></pre></div><p>This produces a file in the <code>openfhe</code> exit dialect (part of HEIR).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span><span style=color:#000;font-weight:700>!</span><span style=color:#f57900>Z1005037682689_i64_ =</span> <span style=color:#000;font-weight:700>!</span>mod_arith<span style=color:#000;font-weight:700>.</span>int<span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>1005037682689</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i64</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>!</span><span style=color:#f57900>Z1032955396097_i64_ =</span> <span style=color:#000;font-weight:700>!</span>mod_arith<span style=color:#000;font-weight:700>.</span>int<span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>1032955396097</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i64</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>!</span><span style=color:#f57900>Z1095233372161_i64_ =</span> <span style=color:#000;font-weight:700>!</span>mod_arith<span style=color:#000;font-weight:700>.</span>int<span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>1095233372161</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i64</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>#polynomial_evaluation_encoding</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>#lwe.polynomial_evaluation_encoding</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>cleartext_start =</span> <span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>cleartext_bitwidth =</span> <span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>!</span><span style=color:#f57900>rns_L0_ =</span> <span style=color:#000;font-weight:700>!</span>rns<span style=color:#000;font-weight:700>.</span>rns<span style=color:#000;font-weight:700>&lt;!</span>Z1095233372161_i64_<span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>!</span><span style=color:#f57900>rns_L1_ =</span> <span style=color:#000;font-weight:700>!</span>rns<span style=color:#000;font-weight:700>.</span>rns<span style=color:#000;font-weight:700>&lt;!</span>Z1095233372161_i64_<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>!</span>Z1032955396097_i64_<span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>!</span><span style=color:#f57900>rns_L2_ =</span> <span style=color:#000;font-weight:700>!</span>rns<span style=color:#000;font-weight:700>.</span>rns<span style=color:#000;font-weight:700>&lt;!</span>Z1095233372161_i64_<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>!</span>Z1032955396097_i64_<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>!</span>Z1005037682689_i64_<span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>#ring_rns_L0_1_x8_</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>#polynomial.ring</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>coefficientType =</span> <span style=color:#000;font-weight:700>!</span>rns_L0_<span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>polynomialModulus =</span> <span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#a40000>+</span> <span style=color:#000;font-weight:700>x**</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>&gt;&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>#ring_rns_L1_1_x8_</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>#polynomial.ring</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>coefficientType =</span> <span style=color:#000;font-weight:700>!</span>rns_L1_<span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>polynomialModulus =</span> <span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#a40000>+</span> <span style=color:#000;font-weight:700>x**</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>&gt;&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>#ring_rns_L2_1_x8_</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>#polynomial.ring</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>coefficientType =</span> <span style=color:#000;font-weight:700>!</span>rns_L2_<span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>polynomialModulus =</span> <span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#a40000>+</span> <span style=color:#000;font-weight:700>x**</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>&gt;&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>!</span><span style=color:#f57900>rlwe_pt_L0_ =</span> <span style=color:#000;font-weight:700>!</span>lwe<span style=color:#000;font-weight:700>.</span>rlwe_plaintext<span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>encoding =</span> <span style=color:#000>#polynomial_evaluation_encoding</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>ring =</span> <span style=color:#000>#ring_rns_L0_1_x8_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>underlying_type =</span> <span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>!</span><span style=color:#f57900>rlwe_pt_L1_ =</span> <span style=color:#000;font-weight:700>!</span>lwe<span style=color:#000;font-weight:700>.</span>rlwe_plaintext<span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>encoding =</span> <span style=color:#000>#polynomial_evaluation_encoding</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>ring =</span> <span style=color:#000>#ring_rns_L1_1_x8_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>underlying_type =</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>!</span><span style=color:#f57900>rlwe_pt_L2_ =</span> <span style=color:#000;font-weight:700>!</span>lwe<span style=color:#000;font-weight:700>.</span>rlwe_plaintext<span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>encoding =</span> <span style=color:#000>#polynomial_evaluation_encoding</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>ring =</span> <span style=color:#000>#ring_rns_L2_1_x8_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>underlying_type =</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>#rlwe_params_L0_</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>#lwe.rlwe_params</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>ring =</span> <span style=color:#000>#ring_rns_L0_1_x8_</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>#rlwe_params_L1_</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>#lwe.rlwe_params</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>ring =</span> <span style=color:#000>#ring_rns_L1_1_x8_</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>#rlwe_params_L2_</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>#lwe.rlwe_params</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>ring =</span> <span style=color:#000>#ring_rns_L2_1_x8_</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>#rlwe_params_L2_D3_</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>#lwe.rlwe_params</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>dimension =</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>ring =</span> <span style=color:#000>#ring_rns_L2_1_x8_</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>!</span><span style=color:#f57900>rlwe_ct_L0_ =</span> <span style=color:#000;font-weight:700>!</span>lwe<span style=color:#000;font-weight:700>.</span>rlwe_ciphertext<span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>encoding =</span> <span style=color:#000>#polynomial_evaluation_encoding</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>rlwe_params =</span> <span style=color:#000>#rlwe_params_L0_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>underlying_type =</span> <span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>!</span><span style=color:#f57900>rlwe_ct_L1_ =</span> <span style=color:#000;font-weight:700>!</span>lwe<span style=color:#000;font-weight:700>.</span>rlwe_ciphertext<span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>encoding =</span> <span style=color:#000>#polynomial_evaluation_encoding</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>rlwe_params =</span> <span style=color:#000>#rlwe_params_L1_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>underlying_type =</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>!</span><span style=color:#f57900>rlwe_ct_L1_1 =</span> <span style=color:#000;font-weight:700>!</span>lwe<span style=color:#000;font-weight:700>.</span>rlwe_ciphertext<span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>encoding =</span> <span style=color:#000>#polynomial_evaluation_encoding</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>rlwe_params =</span> <span style=color:#000>#rlwe_params_L1_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>underlying_type =</span> <span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>!</span><span style=color:#f57900>rlwe_ct_L2_ =</span> <span style=color:#000;font-weight:700>!</span>lwe<span style=color:#000;font-weight:700>.</span>rlwe_ciphertext<span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>encoding =</span> <span style=color:#000>#polynomial_evaluation_encoding</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>rlwe_params =</span> <span style=color:#000>#rlwe_params_L2_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>underlying_type =</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>!</span><span style=color:#f57900>rlwe_ct_L2_D3_ =</span> <span style=color:#000;font-weight:700>!</span>lwe<span style=color:#000;font-weight:700>.</span>rlwe_ciphertext<span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>encoding =</span> <span style=color:#000>#polynomial_evaluation_encoding</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>rlwe_params =</span> <span style=color:#000>#rlwe_params_L2_D3_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>underlying_type =</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;</span>
</span></span><span style=display:flex><span>module <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@dot_product</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>openfhe<span style=color:#000;font-weight:700>.</span>crypto_context<span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg1</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>rlwe_ct_L2_<span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>rlwe_ct_L2_<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>rlwe_ct_L0_ <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%cst</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> dense<span style=color:#000;font-weight:700>&lt;[</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>]&gt;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i64</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> openfhe<span style=color:#000;font-weight:700>.</span>mul_no_relin <span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg2</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>(!</span>openfhe<span style=color:#000;font-weight:700>.</span>crypto_context<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>!</span>rlwe_ct_L2_<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>!</span>rlwe_ct_L2_<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>rlwe_ct_L2_D3_
</span></span><span style=display:flex><span>    <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> openfhe<span style=color:#000;font-weight:700>.</span>relin <span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>(!</span>openfhe<span style=color:#000;font-weight:700>.</span>crypto_context<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>!</span>rlwe_ct_L2_D3_<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>rlwe_ct_L2_
</span></span><span style=display:flex><span>    <span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> openfhe<span style=color:#000;font-weight:700>.</span>rot <span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>index =</span> <span style=color:#0000cf;font-weight:700>4</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>index</span><span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>(!</span>openfhe<span style=color:#000;font-weight:700>.</span>crypto_context<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>!</span>rlwe_ct_L2_<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>rlwe_ct_L2_
</span></span><span style=display:flex><span>    <span style=color:#000>%3</span> <span style=color:#000;font-weight:700>=</span> openfhe<span style=color:#000;font-weight:700>.</span>add <span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%2</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>(!</span>openfhe<span style=color:#000;font-weight:700>.</span>crypto_context<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>!</span>rlwe_ct_L2_<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>!</span>rlwe_ct_L2_<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>rlwe_ct_L2_
</span></span><span style=display:flex><span>    <span style=color:#000>%4</span> <span style=color:#000;font-weight:700>=</span> openfhe<span style=color:#000;font-weight:700>.</span>rot <span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%3</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>index =</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>index</span><span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>(!</span>openfhe<span style=color:#000;font-weight:700>.</span>crypto_context<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>!</span>rlwe_ct_L2_<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>rlwe_ct_L2_
</span></span><span style=display:flex><span>    <span style=color:#000>%5</span> <span style=color:#000;font-weight:700>=</span> openfhe<span style=color:#000;font-weight:700>.</span>add <span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%4</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>(!</span>openfhe<span style=color:#000;font-weight:700>.</span>crypto_context<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>!</span>rlwe_ct_L2_<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>!</span>rlwe_ct_L2_<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>rlwe_ct_L2_
</span></span><span style=display:flex><span>    <span style=color:#000>%6</span> <span style=color:#000;font-weight:700>=</span> openfhe<span style=color:#000;font-weight:700>.</span>rot <span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%5</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>index =</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>index</span><span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>(!</span>openfhe<span style=color:#000;font-weight:700>.</span>crypto_context<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>!</span>rlwe_ct_L2_<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>rlwe_ct_L2_
</span></span><span style=display:flex><span>    <span style=color:#000>%7</span> <span style=color:#000;font-weight:700>=</span> openfhe<span style=color:#000;font-weight:700>.</span>add <span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%5</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%6</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>(!</span>openfhe<span style=color:#000;font-weight:700>.</span>crypto_context<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>!</span>rlwe_ct_L2_<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>!</span>rlwe_ct_L2_<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>rlwe_ct_L2_
</span></span><span style=display:flex><span>    <span style=color:#000>%8</span> <span style=color:#000;font-weight:700>=</span> openfhe<span style=color:#000;font-weight:700>.</span>mod_reduce <span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%7</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>(!</span>openfhe<span style=color:#000;font-weight:700>.</span>crypto_context<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>!</span>rlwe_ct_L2_<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>rlwe_ct_L1_
</span></span><span style=display:flex><span>    <span style=color:#000>%9</span> <span style=color:#000;font-weight:700>=</span> openfhe<span style=color:#000;font-weight:700>.</span>make_packed_plaintext <span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%cst</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>(!</span>openfhe<span style=color:#000;font-weight:700>.</span>crypto_context<span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i64</span><span style=color:#000;font-weight:700>&gt;)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>rlwe_pt_L1_
</span></span><span style=display:flex><span>    <span style=color:#000>%10</span> <span style=color:#000;font-weight:700>=</span> openfhe<span style=color:#000;font-weight:700>.</span>mul_plain <span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%8</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%9</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>(!</span>openfhe<span style=color:#000;font-weight:700>.</span>crypto_context<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>!</span>rlwe_ct_L1_<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>!</span>rlwe_pt_L1_<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>rlwe_ct_L1_
</span></span><span style=display:flex><span>    <span style=color:#000>%11</span> <span style=color:#000;font-weight:700>=</span> openfhe<span style=color:#000;font-weight:700>.</span>rot <span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%10</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>index =</span> <span style=color:#0000cf;font-weight:700>7</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>index</span><span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>(!</span>openfhe<span style=color:#000;font-weight:700>.</span>crypto_context<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>!</span>rlwe_ct_L1_<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>rlwe_ct_L1_
</span></span><span style=display:flex><span>    <span style=color:#000>%12</span> <span style=color:#000;font-weight:700>=</span> lwe<span style=color:#000;font-weight:700>.</span>reinterpret_underlying_type <span style=color:#000>%11</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>rlwe_ct_L1_ to <span style=color:#000;font-weight:700>!</span>rlwe_ct_L1_1
</span></span><span style=display:flex><span>    <span style=color:#000>%13</span> <span style=color:#000;font-weight:700>=</span> openfhe<span style=color:#000;font-weight:700>.</span>mod_reduce <span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%12</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>(!</span>openfhe<span style=color:#000;font-weight:700>.</span>crypto_context<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>!</span>rlwe_ct_L1_1<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>rlwe_ct_L0_
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>%13</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>rlwe_ct_L0_
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@dot_product__encrypt__arg0</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>openfhe<span style=color:#000;font-weight:700>.</span>crypto_context<span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg1</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>openfhe<span style=color:#000;font-weight:700>.</span>public_key<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>rlwe_ct_L2_ <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@dot_product__encrypt__arg1</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>openfhe<span style=color:#000;font-weight:700>.</span>crypto_context<span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg1</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>openfhe<span style=color:#000;font-weight:700>.</span>public_key<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>rlwe_ct_L2_ <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@dot_product__decrypt__result0</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>openfhe<span style=color:#000;font-weight:700>.</span>crypto_context<span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg1</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>rlwe_ct_L0_<span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>openfhe<span style=color:#000;font-weight:700>.</span>private_key<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#204a87;font-weight:700>i16</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@dot_product__generate_crypto_context</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>openfhe<span style=color:#000;font-weight:700>.</span>crypto_context <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@dot_product__configure_crypto_context</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>openfhe<span style=color:#000;font-weight:700>.</span>crypto_context<span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg1</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>openfhe<span style=color:#000;font-weight:700>.</span>private_key<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>openfhe<span style=color:#000;font-weight:700>.</span>crypto_context <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>Next, we use the <code>heir-translate</code> tool to run code generation for the OpenFHE
<code>pke</code> API.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bazel run //tools:heir-translate -- --emit-openfhe-pke-header <span style=color:#000>$PWD</span>/output.mlir &gt; heir_output.h
</span></span><span style=display:flex><span>bazel run //tools:heir-translate -- --emit-openfhe-pke <span style=color:#000>$PWD</span>/output.mlir &gt; heir_output.cpp
</span></span></code></pre></div><p>The results:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// heir_output.h
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#8f5902;font-style:italic>#include</span> <span style=color:#8f5902;font-style:italic>&#34;src/pke/include/openfhe.h&#34; // from @openfhe</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>using</span> <span style=color:#204a87;font-weight:700>namespace</span> <span style=color:#000>lbcrypto</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>using</span> <span style=color:#000>CiphertextT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ConstCiphertext</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>DCRTPoly</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>using</span> <span style=color:#000>CCParamsT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>CCParams</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>CryptoContextBGVRNS</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>using</span> <span style=color:#000>CryptoContextT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>CryptoContext</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>DCRTPoly</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>using</span> <span style=color:#000>EvalKeyT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>EvalKey</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>DCRTPoly</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>using</span> <span style=color:#000>PlaintextT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Plaintext</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>using</span> <span style=color:#000>PrivateKeyT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PrivateKey</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>DCRTPoly</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>using</span> <span style=color:#000>PublicKeyT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PublicKey</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>DCRTPoly</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>CiphertextT</span> <span style=color:#000>dot_product</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>CryptoContextT</span> <span style=color:#000>v0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>CiphertextT</span> <span style=color:#000>v1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>CiphertextT</span> <span style=color:#000>v2</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000>CiphertextT</span> <span style=color:#000>dot_product__encrypt__arg0</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>CryptoContextT</span> <span style=color:#000>v18</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>vector</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>int16_t</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>v19</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>PublicKeyT</span> <span style=color:#000>v20</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000>CiphertextT</span> <span style=color:#000>dot_product__encrypt__arg1</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>CryptoContextT</span> <span style=color:#000>v24</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>vector</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>int16_t</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>v25</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>PublicKeyT</span> <span style=color:#000>v26</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>int16_t</span> <span style=color:#000>dot_product__decrypt__result0</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>CryptoContextT</span> <span style=color:#000>v30</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>CiphertextT</span> <span style=color:#000>v31</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>PrivateKeyT</span> <span style=color:#000>v32</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000>CryptoContextT</span> <span style=color:#000>dot_product__generate_crypto_context</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#000>CryptoContextT</span> <span style=color:#000>dot_product__configure_crypto_context</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>CryptoContextT</span> <span style=color:#000>v37</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>PrivateKeyT</span> <span style=color:#000>v38</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// heir_output.cpp
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#8f5902;font-style:italic>#include</span> <span style=color:#8f5902;font-style:italic>&#34;src/pke/include/openfhe.h&#34; // from @openfhe</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>using</span> <span style=color:#204a87;font-weight:700>namespace</span> <span style=color:#000>lbcrypto</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>using</span> <span style=color:#000>CiphertextT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ConstCiphertext</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>DCRTPoly</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>using</span> <span style=color:#000>CryptoContextT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>CryptoContext</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>DCRTPoly</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>using</span> <span style=color:#000>EvalKeyT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>EvalKey</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>DCRTPoly</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>using</span> <span style=color:#000>PlaintextT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Plaintext</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>using</span> <span style=color:#000>PrivateKeyT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PrivateKey</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>DCRTPoly</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>using</span> <span style=color:#000>PublicKeyT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PublicKey</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>DCRTPoly</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>CiphertextT</span> <span style=color:#000>dot_product</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>CryptoContextT</span> <span style=color:#000>v0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>CiphertextT</span> <span style=color:#000>v1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>CiphertextT</span> <span style=color:#000>v2</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>vector</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>int64_t</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>v3</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>};</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>const</span> <span style=color:#204a87;font-weight:700>auto</span><span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>v4</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>v0</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>EvalMultNoRelin</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>v1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>v2</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>const</span> <span style=color:#204a87;font-weight:700>auto</span><span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>v5</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>v0</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>Relinearize</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>v4</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>const</span> <span style=color:#204a87;font-weight:700>auto</span><span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>v6</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>v0</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>EvalRotate</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>v5</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>const</span> <span style=color:#204a87;font-weight:700>auto</span><span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>v7</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>v0</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>EvalAdd</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>v5</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>v6</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>const</span> <span style=color:#204a87;font-weight:700>auto</span><span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>v8</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>v0</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>EvalRotate</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>v7</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>const</span> <span style=color:#204a87;font-weight:700>auto</span><span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>v9</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>v0</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>EvalAdd</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>v7</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>v8</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>const</span> <span style=color:#204a87;font-weight:700>auto</span><span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>v10</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>v0</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>EvalRotate</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>v9</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>const</span> <span style=color:#204a87;font-weight:700>auto</span><span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>v11</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>v0</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>EvalAdd</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>v9</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>v10</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>const</span> <span style=color:#204a87;font-weight:700>auto</span><span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>v12</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>v0</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>ModReduce</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>v11</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>auto</span> <span style=color:#000>v3_filled_n</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>v0</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>GetCryptoParameters</span><span style=color:#000;font-weight:700>()</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>GetElementParams</span><span style=color:#000;font-weight:700>()</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>GetRingDimension</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>auto</span> <span style=color:#000>v3_filled</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>v3</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>v3_filled</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clear</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>  <span style=color:#000>v3_filled</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>reserve</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>v3_filled_n</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>auto</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>v3_filled_n</span><span style=color:#000;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>v3_filled</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>push_back</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>v3</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>%</span> <span style=color:#000>v3</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>size</span><span style=color:#000;font-weight:700>()]);</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>const</span> <span style=color:#204a87;font-weight:700>auto</span><span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>v13</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>v0</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>MakePackedPlaintext</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>v3_filled</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>const</span> <span style=color:#204a87;font-weight:700>auto</span><span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>v14</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>v0</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>EvalMult</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>v12</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>v13</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>const</span> <span style=color:#204a87;font-weight:700>auto</span><span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>v15</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>v0</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>EvalRotate</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>v14</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>7</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>const</span> <span style=color:#204a87;font-weight:700>auto</span><span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>v16</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>v15</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>const</span> <span style=color:#204a87;font-weight:700>auto</span><span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>v17</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>v0</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>ModReduce</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>v16</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>v17</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000>CiphertextT</span> <span style=color:#000>dot_product__encrypt__arg0</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>CryptoContextT</span> <span style=color:#000>v24</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>vector</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>int16_t</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>v25</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>PublicKeyT</span> <span style=color:#000>v26</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000>CiphertextT</span> <span style=color:#000>dot_product__encrypt__arg1</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>CryptoContextT</span> <span style=color:#000>v29</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>vector</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>int16_t</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>v30</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>PublicKeyT</span> <span style=color:#000>v31</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>int16_t</span> <span style=color:#000>dot_product__decrypt__result0</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>CryptoContextT</span> <span style=color:#000>v34</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>CiphertextT</span> <span style=color:#000>v35</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>PrivateKeyT</span> <span style=color:#000>v36</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000>CryptoContextT</span> <span style=color:#000>dot_product__generate_crypto_context</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000>CryptoContextT</span> <span style=color:#000>dot_product__configure_crypto_context</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>CryptoContextT</span> <span style=color:#000>v37</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>PrivateKeyT</span> <span style=color:#000>v38</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>At this point we can compile the program as we would a normal OpenFHE program.
Note that the above two files just contain the compiled function and
encryption/decryption helpers, and does not include any code that provides
specific inputs or calls these functions.</p><p>Next we&rsquo;ll create a harness that provides sample inputs, encrypts them, runs the
compiled function, and decrypts the result. Once you have the generated header
and cpp files, you can do this with any build system. We will use bazel for
consistency.</p><p>Create a file called <code>BUILD</code> in the same directory as the header and cpp files
above, with the following contents:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-BUILD data-lang=BUILD><span style=display:flex><span><span style=color:#8f5902;font-style:italic># A library build target that encapsulates the HEIR-generated code.</span>
</span></span><span style=display:flex><span><span style=color:#000>cc_library</span><span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>    <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;dot_product_codegen&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#000>srcs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;heir_output.cpp&#34;</span><span style=color:#000;font-weight:700>],</span>
</span></span><span style=display:flex><span>    <span style=color:#000>hdrs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;heir_output.h&#34;</span><span style=color:#000;font-weight:700>],</span>
</span></span><span style=display:flex><span>    <span style=color:#000>deps</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;@openfhe//:pke&#34;</span><span style=color:#000;font-weight:700>],</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># An executable build target that contains your main function and links</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># against the above.</span>
</span></span><span style=display:flex><span><span style=color:#000>cc_binary</span><span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>    <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;dot_product_main&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#000>srcs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;dot_product_main.cpp&#34;</span><span style=color:#000;font-weight:700>],</span>
</span></span><span style=display:flex><span>    <span style=color:#000>deps</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[</span>
</span></span><span style=display:flex><span>        <span style=color:#4e9a06>&#34;:dot_product_codegen&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>        <span style=color:#4e9a06>&#34;@openfhe//:pke&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>        <span style=color:#4e9a06>&#34;@openfhe//:core&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>],</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div><p>Where <code>dot_product_main.cpp</code> is a new file containing</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#include</span> <span style=color:#8f5902;font-style:italic>&lt;cstdint&gt;</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#include</span> <span style=color:#8f5902;font-style:italic>&lt;vector&gt;</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#include</span> <span style=color:#8f5902;font-style:italic>&#34;src/pke/include/openfhe.h&#34; // from @openfhe</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#include</span> <span style=color:#8f5902;font-style:italic>&#34;heir_output.h&#34;</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>argc</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>char</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>argv</span><span style=color:#000;font-weight:700>[])</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>CryptoContext</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>DCRTPoly</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>cryptoContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>dot_product__generate_crypto_context</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#000>KeyPair</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>DCRTPoly</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>keyPair</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>keyPair</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cryptoContext</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>KeyGen</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#000>cryptoContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>dot_product__configure_crypto_context</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cryptoContext</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>keyPair</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>secretKey</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>vector</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>int16_t</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>arg0</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>7</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>};</span>
</span></span><span style=display:flex><span>  <span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>vector</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>int16_t</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>arg1</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>7</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>9</span><span style=color:#000;font-weight:700>};</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>int64_t</span> <span style=color:#000>expected</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>240</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>auto</span> <span style=color:#000>arg0Encrypted</span> <span style=color:#ce5c00;font-weight:700>=</span>
</span></span><span style=display:flex><span>      <span style=color:#000>dot_product__encrypt__arg0</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cryptoContext</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>keyPair</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>publicKey</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>auto</span> <span style=color:#000>arg1Encrypted</span> <span style=color:#ce5c00;font-weight:700>=</span>
</span></span><span style=display:flex><span>      <span style=color:#000>dot_product__encrypt__arg1</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cryptoContext</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>arg1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>keyPair</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>publicKey</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>auto</span> <span style=color:#000>outputEncrypted</span> <span style=color:#ce5c00;font-weight:700>=</span>
</span></span><span style=display:flex><span>      <span style=color:#000>dot_product</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cryptoContext</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>arg0Encrypted</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>arg1Encrypted</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>auto</span> <span style=color:#000>actual</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>dot_product__decrypt__result0</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cryptoContext</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>outputEncrypted</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                                              <span style=color:#000>keyPair</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>secretKey</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>cout</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#4e9a06>&#34;Expected: &#34;</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>expected</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>cout</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#4e9a06>&#34;Actual: &#34;</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>actual</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>Then run and show the results:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ bazel run dot_product_main
</span></span><span style=display:flex><span>Expected: <span style=color:#0000cf;font-weight:700>240</span>
</span></span><span style=display:flex><span>Actual: <span style=color:#0000cf;font-weight:700>240</span>
</span></span></code></pre></div><h3 id=optional-run-a-custom-heir-opt-pipeline>Optional: Run a custom <code>heir-opt</code> pipeline</h3><p>HEIR comes with two central binaries, <code>heir-opt</code> for running optimization passes
and dialect conversions, and <code>heir-translate</code> for backend code generation. To
see the list of available passes in each one, run the binary with <code>--help</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bazel run //tools:heir-opt -- --help
</span></span><span style=display:flex><span>bazel run //tools:heir-translate -- --help
</span></span></code></pre></div><p>Once you&rsquo;ve chosen a pass or <code>--pass-pipeline</code> to run, execute it on the desired
file. For example, you can run a test file through <code>heir-opt</code> to see its output.
Note that when the binary is run via <code>bazel</code>, you must pass absolute paths to
input files. You can also access the underlying binary at
<code>bazel-bin/tools/heir-opt</code>, provided it has already been built.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bazel run //tools:heir-opt -- <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --secret-to-cggi -cse <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  <span style=color:#000>$PWD</span>/tests/Dialect/Secret/Conversions/secret_to_cggi/add_one.mlir
</span></span></code></pre></div><p>To convert an existing lit test to a <code>bazel run</code> command for manual tweaking and
introspection (e.g., adding <code>--debug</code> or <code>--mlir-print-ir-after-all</code> to see how
he IR changes with each pass), use <code>python scripts/lit_to_bazel.py</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># after pip installing requirements-dev.txt</span>
</span></span><span style=display:flex><span>python scripts/lit_to_bazel.py tests/simd/box_blur_64x64.mlir
</span></span></code></pre></div><p>Which outputs</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bazel run --noallow_analysis_cache_discard //tools:heir-opt -- <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--secretize --wrap-generic --canonicalize --cse --full-loop-unroll <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--insert-rotate --cse --canonicalize --collapse-insertion-chains <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--canonicalize --cse /path/to/heir/tests/simd/box_blur_64x64.mlir
</span></span></code></pre></div><h3 id=optional-graphviz-visualization-of-the-ir>Optional: Graphviz visualization of the IR</h3><p>Getting a visualization of the IR during optimization/transformation might help
you understand what is going on more easily.</p><p>Still taking the <code>dot_product_8.mlir</code> as an example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bazel run --ui_event_filters<span style=color:#ce5c00;font-weight:700>=</span>-info,-debug,-warning,-stderr,-stdout --noshow_progress --logging<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span> //tools:heir-opt -- --wrap-generic --heir-simd-vectorizer <span style=color:#000>$PWD</span>/tests/Examples/openfhe/dot_product_8.mlir --view-op-graph 2&gt; dot_product_8.dot
</span></span><span style=display:flex><span>dot -Tpdf dot_product_8.dot &gt; dot_product_8.pdf
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># open pdf in your favorite pdf viewer</span>
</span></span></code></pre></div><p>The diagram is also shown below. It demonstrates that the HEIR SIMD vectorizer
would vectorize the dot-product program (<code>tensor&lt;8xi16></code>) then use
rotate-and-reduce technique to compute the sum.</p><figure><a href=/images/dot_product_8.svg><img src=/images/dot_product_8.svg></a></figure></div><div class=td-content style=page-break-before:always><h1 id=pg-05b7a8e562e0a482b29460c121776963>2 - Contributing to HEIR</h1><p>There are several ways to contribute to HEIR, including:</p><ul><li>Discussing high-level designs and questions on HEIR&rsquo;s
<a href=https://github.com/google/heir/discussions>discussions page</a></li><li>Improving or expanding HEIR&rsquo;s documentation</li><li>Contributing to HEIR&rsquo;s <a href=https://github.com/google/heir>code-base</a></li><li>Discuss project direction at HEIR&rsquo;s
<a href=https://heir.dev/community/>Working Group meetings</a></li></ul><h2 id=ways-to-contribute>Ways to contribute</h2><p>We welcome pull requests, and have tagged issues for newcomers:</p><ul><li><a href="https://github.com/google/heir/issues?q=is%3Aissue+is%3Aopen+label%3A%22good+first+issue%22">Good first issue</a></li><li><a href="https://github.com/google/heir/issues?q=is%3Aissue+is%3Aopen+label%3A%22contributions+welcome%22">Contributions welcome</a></li><li><a href=https://github.com/google/heir/labels/research%20synthesis>Research synthesis</a>:
determine what parts of recent FHE research papers can or should be ported to
HEIR.</li></ul><p>For new proposals, please open a GitHub
<a href=https://github.com/google/heir/issues>issue</a> or start a
<a href=https://github.com/google/heir/discussions>discussion</a> for feedback.</p><h2 id=contributing-code-to-heir>Contributing code to HEIR</h2><p>The following steps should look familiar to typical workflows for pull request
contributions. Feel free to consult
<a href=https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/about-pull-requests>GitHub Help</a>
if you need more information using pull requests. HEIR-specific processes begin
at the <a href=#pull-request-review-flow>pull request review stage</a>.</p><h3 id=setup>Setup</h3><ol><li><p>Fork the HEIR repository by clicking the <strong>Fork</strong> button on the
<a href=https://github.com/google/heir>repository page</a>. This creates a copy of the
HEIR repository on your own GitHub account, where you can make changes.</p><details><summary>Setting up git to work with fork and upstream remotes.</summary>
If you have cloned your fork, you will want to
add the HEIR repository as an upstream remote:<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git remote add upstream https://www.github.com/google/heir
</span></span></code></pre></div><p>Alternatively, if you have cloned the main HEIR repo, you can add your fork
as a remote like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git remote rename origin upstream
</span></span><span style=display:flex><span>git remote add origin https://www.github.com/&lt;USERNAME&gt;/heir
</span></span></code></pre></div><p>Either way, you will want to create a development branch for your change:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git checkout -b name-of-change
</span></span></code></pre></div><p>In the remainder of this document, we will assume <code>origin</code> is your fork, and
<code>upstream</code> is the main HEIR repo.</p></details></li><li><p>See <a href=https://heir.dev/docs/development/>Development</a> for information on
installing developer dependencies, building and running tests, and adding new
dialects or passes.</p></li><li><p>Sign the
<a href=https://cla.developers.google.com/about>Contributor License Agreement</a>
(CLA). If you are working on HEIR as part of your employment, you might have
to instead sign a Corporate CLA. See more
<a href=https://github.com/google/heir/blob/main/CONTRIBUTING.md#sign-our-contributor-license-agreement>here</a>.</p></li></ol><h3 id=preparing-a-pull-request>Preparing a pull request</h3><ol><li><p>Sync your changes against the upstream HEIR repository, i.e., make sure your
contributions are (re)based of the most recent <code>upstream/main</code> commit.</p></li><li><p>Check HEIR&rsquo;s lint and style checks by running the following from the top of
the repository:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span> pre-commit run --all
</span></span></code></pre></div></li></ol><p>If failed, check <a href=https://heir.dev/docs/development/#pre-commit>Pre-commit</a>.</p><ol><li><p>Make sure tests are passing with the following:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span> bazel <span style=color:#204a87>test</span> @heir//...
</span></span></code></pre></div></li><li><p>Once you are ready with your change, create a commit, e.g.:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git add change.cpp
</span></span><span style=display:flex><span>git commit -m <span style=color:#4e9a06>&#34;Detailed commit message&#34;</span>
</span></span><span style=display:flex><span>git push --set-upstream origin name-of-change
</span></span></code></pre></div></li></ol><h3 id=pull-request-review-flow>Pull request review flow</h3><ol><li><strong>New PR</strong>:</li></ol><ul><li>When a new PR is submitted, it is inspected for quality requirements, such as
the CLA requirement, and a sufficient PR description.</li><li>If the PR passes checks, we assign a reviewer. If not, we request additional
changes to ensure the PR passes CI checks.</li></ul><ol start=2><li><strong>Review</strong></li></ol><ul><li>A reviewer will check the PR and potentially request additional changes.</li><li>If a change is needed, the contributor is requested to make a suggested
change. Please make changes with additional commits to your PR, to ensure that
the reviewer can easily see the diff.</li><li>If all looks good, the reviewer will approve the PR.</li><li>This cycle repeats itself until the PR is approved.</li></ul><ol start=3><li><strong>Approved</strong></li></ol><ul><li><strong>At this stage, you must squash your commits into a single commit.</strong></li><li>Once the PR is approved, a GitHub workflow will
<a href=https://github.com/google/heir/blob/main/.github/workflows/pr_review.yml>check</a>
your PR for multiple commits. You may use the <code>git rebase -i</code> to squash the
commits. Pull requests must consist of a single git commit before merging.</li></ul><ol start=4><li><strong>Pull Ready</strong></li></ol><ul><li>Once the PR is squashed into a single git commit, a maintainer will apply the
<code>pull ready</code> label.</li><li>This initiates the internal code migration and presubmits.</li><li>After the internal process is finished, the commit will be added to <code>main</code> and
the PR closed as merged by that commit.</li></ul><h3 id=internal-review-details>Internal review details</h3><p>This diagram summarizes the GitHub/Google code synchronization process. This is
largely automated by a Google-owned system called
<a href=https://github.com/google/copybara>Copybara</a>, the configuration for which is
Google-internal. This system treats the Google-internal version of HEIR as the
source of truth, and applies specified transformation rules to copy internal
changes to GitHub and integrate external PRs internally.</p><p>Notable aspects:</p><ul><li>The final merged code may differ slightly from a PR. The changes are mainly to
support stricter internal requirements for BUILD files that we cannot
reproduce externally due to minor differences between Google&rsquo;s internal build
systems and bazel that we don&rsquo;t know how to align. Sometimes they will also
include additional code quality fixes suggested by internal static analyzers
that do not exist outside of Google.</li><li>Due to the above, signed commits with internal modifications will not maintain
valid signatures after merging, which labels the commit with a warning.</li><li>You will see various actions taken on GitHub that include <code>copybara</code> in the
name, such as changes that originate from Google engineers doing various
approved migrations (e.g., migrating HEIR to support changes in MLIR or
abseil).</li></ul><figure><a href=/images/heir-copybara.png><img src=/images/heir-copybara.png></a><figcaption><h4>A diagram summarizing the copybara flow for HEIR internally to Google</h4></figcaption></figure><h3 id=why-bother-with-copybara>Why bother with Copybara?</h3><p>tl;dr: Automatic syncing with upstream MLIR and associated code migration.</p><p>Until HEIR has a formal governance structure in place, Google
engineers—specifically Asra Ali, Shruthi Gorantala, and Jeremy Kun—are the
codebase stewards. Because the project is young and the team is small, we want
to reduce our workload. One important aspect of that is keeping up to date with
the upstream MLIR project and incorporating bug fixes and new features into
HEIR. Google also wishes to stay up to date with MLIR and LLVM, and so it has
tooling devoted to integrating new MLIR changes into Google&rsquo;s monorepo every few
hours. As part of that rotation, a set of approved internal projects that depend
on MLIR (like TensorFlow) are patched to support breaking changes in MLIR. HEIR
is one of those approved projects.</p><p>As shown in the previous section, the cost of this is that no change can go into
HEIR without at least two Googlers approving it, and the project is held to a
specific set of code quality standards, namely Google&rsquo;s. We acknowledge these
quirks, and look forward to the day when HEIR is useful enough and important
enough that we can revisit this governance structure with the community.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-1bf07101845de6da98f1c948b82c5ce0>3 - Development</h1><h2 id=ide-configuration-vs-code>IDE Configuration (VS Code)</h2><p>While a wide variety of IDEs and editors can be used for HEIR development, we
currently only provide support for <a href=https://code.visualstudio.com/>VSCode</a>.</p><h3 id=setup>Setup</h3><p>For the best experience, we recommend following these steps:</p><ul><li><p>Install the
<a href="https://marketplace.visualstudio.com/items?itemName=llvm-vs-code-extensions.vscode-mlir">MLIR</a>,
<a href="https://marketplace.visualstudio.com/items?itemName=llvm-vs-code-extensions.vscode-clangd">clangd</a>
and
<a href="https://marketplace.visualstudio.com/items?itemName=BazelBuild.vscode-bazel">Bazel</a>
extensions</p></li><li><p>Install and rename Buildifier:</p><p>You can download the latest Buildifier release, e.g., for linux-amd64 (see the
<a href=https://github.com/bazelbuild/buildtools/releases/latest/>Bazelisk Release Page</a>
for a list of available binaries):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wget -c https://github.com/bazelbuild/buildtools/releases/latest/download/buildifier-linux-amd64
</span></span><span style=display:flex><span>mv buildifier-linux-amd64 buildifier
</span></span><span style=display:flex><span>chmod +x buildifier
</span></span></code></pre></div><p>Just as with bazel, you will want to move this somewhere on your PATH, e.g.:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir ~/bin
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#39;export PATH=$PATH:~/bin&#39;</span> &gt;&gt; ~/.bashrc
</span></span><span style=display:flex><span>mv buildifier ~/bin/buildifier
</span></span></code></pre></div><p>VS Code should automatically detect buildifier. If this is not successful, you
can manually set the &ldquo;Buildifier Executable&rdquo; setting for the Bazel extension
(<code>bazel.buildifierExecutable</code>).</p></li><li><p>Disable the
<a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode.cpptools">C/C++ (aka &lsquo;cpptools&rsquo;)</a>
extension (either completely, or in the current workspace).</p></li><li><p>Add the following snippet to your VS Code user settings found in
.vscode/settings.json to enable autocomplete based on the
compile_commands.json file.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>  <span style=color:#4e9a06>&#34;clangd.arguments&#34;</span><span style=color:#a40000>:</span> <span style=color:#000;font-weight:700>[</span>
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#34;--compile-commands-dir=${workspaceFolder}/&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#34;--completion-style=detailed&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#34;--query-driver=**&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>]</span><span style=color:#a40000>,</span>
</span></span></code></pre></div></li><li><p>To generate the <code>compile_commands.json</code> file, run</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>bazel run @hedron_compile_commands//:refresh_all
</span></span></code></pre></div><p>This will need to be regenerated every time you want tooling to see new
<code>BUILD</code> file changes.</p><p>If you encounter errors like <code>*.h.inc</code> not found, or syntax errors inside
these files, you may need to build those targets and then re-run the
<code>refresh_all</code> command above.</p></li><li><p>It might be necesssary to add the path to your buildifier to VSCode, though it
should be auto-detected.</p><ul><li>Open the heir folder in VSCode</li><li>Go to &lsquo;Settings&rsquo; and set it on the &lsquo;Workspace&rsquo;</li><li>Search for &ldquo;Bazel Buildifier Executable&rdquo;</li><li>Once you find it, write <code>[home-directory]/bin/buildifier</code> for your specific
[home-directory].</li></ul></li></ul><h3 id=building-testing-running-and-debugging-with-vscode>Building, Testing, Running and Debugging with VSCode</h3><h4 id=building>Building</h4><ol><li>Open the &ldquo;Explorer&rdquo; (File Overview) in the left panel.</li><li>Find &ldquo;Bazel Build Targets&rdquo; towards the bottom of the &ldquo;Explorer&rdquo; panel and
click the dropdown button.</li><li>Unfold the heir folder</li><li>Right-click on &ldquo;//tools&rdquo; and click the &ldquo;Build Package Recursively&rdquo; option</li></ol><h4 id=testing>Testing</h4><ol><li>Open the &ldquo;Explorer&rdquo; (File Overview) in the left panel.</li><li>Find &ldquo;Bazel Build Targets&rdquo; towards the bottom of the &ldquo;Explorer&rdquo; panel and
click the dropdown button.</li><li>Unfold the heir folder</li><li>Right-click on &ldquo;//test&rdquo; and click the &ldquo;Test Package Recursively&rdquo; option</li></ol><h4 id=running-and-debugging>Running and Debugging</h4><ol><li><p>Create a <code>launch.json</code> file in the <code>.vscode</code> folder, changing the <code>"name"</code>
and <code>"args"</code> as required:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;version&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;0.2.0&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;configurations&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Debug Secret-&gt;BGV&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&#34;preLaunchTask&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;build&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&#34;type&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;lldb&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&#34;request&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;launch&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&#34;program&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;${workspaceFolder}/bazel-bin/tools/heir-opt&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&#34;args&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
</span></span><span style=display:flex><span>                <span style=color:#4e9a06>&#34;--secret-to-bgv&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                <span style=color:#4e9a06>&#34;--debug&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                <span style=color:#4e9a06>&#34;${workspaceFolder}/tests/secret_to_bgv/ops.mlir&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>],</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&#34;relativePathBase&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;${workspaceFolder}&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&#34;sourceMap&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&#34;proc/self/cwd&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;${workspaceFolder}&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&#34;/proc/self/cwd&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;${workspaceFolder}&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>},</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>You can add as many different configurations as necessary.</p></li><li><p>Add Breakpoints to your program as desired.</p></li><li><p>Open the Run/Debug panel on the left, select the desired configuration and
run/debug it.</p></li></ol><ul><li>Note that you might have to hit &ldquo;Enter&rdquo; to proceed past the Bazel build. It
might take several seconds between hitting &ldquo;Enter&rdquo; and the debug terminal
opening.</li></ul><h2 id=tips-for-working-with-bazel>Tips for working with Bazel</h2><h3 id=avoiding-rebuilds>Avoiding rebuilds</h3><p>Bazel is notoriously fickle when it comes to deciding whether a full rebuild is
necessary, which is bad for HEIR because rebuilding LLVM from scratch takes 15
minutes or more.</p><p>The main things that cause a rebuild are:</p><ul><li>A change to the command-line flags passed to bazel, e.g., <code>-c opt</code> vs <code>-c dbg</code>
for optimization level and debug symbols.</li><li>A change to the <code>.bazelrc</code> that implicitly causes a flag change. Note HEIR has
its own project-specific <code>.bazelrc</code> in the root directory.</li><li>A change to relevant command-line variables, such as <code>PATH</code>, which is avoided
by the <code>incompatible_strict_action_env</code> flag. Note activating a python
virtualenv triggers a <code>PATH</code> change.</li></ul><p>Bazel compilation flags are set by default in the project root&rsquo;s <code>.bazelrc</code> in
such a way as to avoid rebuilds during development as much as possible. This
includes setting <code>-c dbg</code> and <code>--incompatible_strict_action_env</code>.</p><h3 id=pointing-heir-to-a-local-clone-of-llvm-project>Pointing HEIR to a local clone of <code>llvm-project</code></h3><p>Occasionally changes in HEIR will need to be made in tandem with upstream
changes in MLIR. In particular, we occasionally find upstream bugs that only
occur with HEIR passes, and we are the primary owners/users of the upstream
<code>polynomial</code> dialect.</p><p>To tell <code>bazel</code> to use a local clone of <code>llvm-project</code> instead of a pinned
commit hash, replace <code>bazel/import_llvm.bzl</code> with the following file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat &gt; bazel/import_llvm.bzl <span style=color:#4e9a06>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;&#34;&#34;Provides the repository macro to import LLVM.&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>def import_llvm(name):
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    &#34;&#34;&#34;Imports LLVM.&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    native.new_local_repository(
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        name = name,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        # this BUILD file is intentionally empty, because the LLVM project
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        # internally contains a set of bazel BUILD files overlaying the project.
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        build_file_content = &#34;# empty&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        path = &#34;/path/to/llvm-project&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    )
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>The next <code>bazel build</code> will require a full rebuild if the checked-out LLVM
commit differs from the pinned commit hash in <code>bazel/import_llvm.bzl</code>.</p><p>Note that you cannot reuse the LLVM CMake build artifacts in the bazel build.
Based on what you&rsquo;re trying to do, this may require some extra steps.</p><ul><li>If you just want to run existing MLIR and HEIR tests against local
<code>llvm-project</code> changes, you can run the tests from HEIR using
<code>bazel test @llvm-project//mlir/...:all</code>. New <code>lit</code> tests can be added in
<code>llvm-project</code>&rsquo;s existing directories and tested this way without a rebuild.</li><li>If you add new CMake targets in <code>llvm-project</code>, then to incorporate them into
HEIR you need to add new bazel targets in
<code>llvm-project/utils/bazel/llvm-project-overlay/mlir/BUILD.bazel</code>. This is
required if, for example, a new dialect or pass is added in MLIR upstream.</li></ul><p>Send any upstream changes to HEIR-relevant MLIR files to @j2kun (Jeremy Kun) who
has LLVM commit access and can also suggest additional MLIR reviewers.</p><h2 id=tips-for-building-dependencies--useful-external-libraries>Tips for building dependencies / useful external libraries</h2><h3 id=mlir>MLIR</h3><p>Instructions for building MLIR can be found on the
<a href=https://mlir.llvm.org/getting_started/>Getting started</a> page of the MLIR
website. The instructions there seem to work as written (tested on Ubuntu
22.04). However, the command shown in <code>Unix-like compile/testing:</code> may require a
large amount of RAM. If building on a system with 16GB of RAM or less, and if
you don&rsquo;t plan to target GPUs, you may want to replace the line</p><pre tabindex=0><code>   -DLLVM_TARGETS_TO_BUILD=&#34;Native;NVPTX;AMDGPU&#34; \
</code></pre><p>with</p><pre tabindex=0><code>   -DLLVM_TARGETS_TO_BUILD=&#34;Native&#34; \
</code></pre><h3 id=openfhe>OpenFHE</h3><p>A simple way to build OpenFHE is to follow the instructions in the
<a href=https://github.com/openfheorg/openfhe-configurator>openfhe-configurator</a>
repository. This allows to build the library with or without support for the
Intel <a href=https://github.com/intel/hexl>HEXL library</a>. First, clone the repository
and configure it using:</p><pre tabindex=0><code>git clone https://github.com/openfheorg/openfhe-configurator.git
cd openfhe-configurator
scripts/configure.sh
</code></pre><p>You will be asked whether to stage a vanilla OpenFHE build or add support for
HEXL. You can then build the library using</p><pre tabindex=0><code>./scripts/build-openfhe-development.sh
</code></pre><p>The build may fail on systems with less than 32GB or RAM due to parallel
compilation. You can disable it by editing
<code>./scripts/build-openfhe-development.sh</code> and replacing</p><pre tabindex=0><code>make -j || abort &#34;Build of openfhe-development failed.&#34;
</code></pre><p>with</p><pre tabindex=0><code>make || abort &#34;Build of openfhe-development failed.&#34;
</code></pre><p>Compilation will be significantly slower but should then take less than 8GB of
memory.</p><h2 id=creating-a-new-pass>Creating a New Pass</h2><p>The <code>scripts/templates</code> folder contains Python scripts to create boilerplate for
new conversion or (dialect-specific) transform passes. These should be used when
the tablegen files containing existing pass definitions in the expected
filepaths are not already present. Otherwise, you should modify the existing
tablegen files directly.</p><h3 id=conversion-pass>Conversion Pass</h3><p>To create a new conversion pass, run a command similar to the following:</p><pre tabindex=0><code>python scripts/templates/templates.py new_conversion_pass \
--source_dialect_name=CGGI \
--source_dialect_namespace=cggi \
--source_dialect_mnemonic=cggi \
--target_dialect_name=TfheRust \
--target_dialect_namespace=tfhe_rust \
--target_dialect_mnemonic=tfhe_rust
</code></pre><p>In order to build the resulting code, you must fix the labeled <code>FIXME</code>s in the
type converter and the op conversion patterns.</p><h3 id=transform-passes>Transform Passes</h3><p>To create a transform or rewrite pass that operates on a dialect, run a command
similar to the following:</p><pre tabindex=0><code>python scripts/templates/templates.py new_dialect_transform \
--pass_name=ForgetSecrets \
--pass_flag=forget-secrets \
--dialect_name=Secret \
--dialect_namespace=secret \
--force=false
</code></pre><p>If the transform does not operate from and to a specific dialect, use</p><pre tabindex=0><code>python scripts/templates/templates.py new_transform \
--pass_name=ForgetSecrets \
--pass_flag=forget-secrets \
--force=false
</code></pre><h2 id=pre-commit>Pre-Commit</h2><p>We use <a href=https://pre-commit.com/>pre-commit</a> to manage a series of git
pre-commit hooks for the project; for example, each time you commit code, the
hooks will make sure that your C++ is formatted properly. If your code isn&rsquo;t,
the hook will format it, so when you try to commit the second time you&rsquo;ll get
past the hook.</p><p>All hooks are defined in <code>.pre-commit-config.yaml</code>. To install these hooks, run</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pip install -r requirements-dev.txt
</span></span></code></pre></div><p>Then install the hooks to run automatically on <code>git commit</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pre-commit install
</span></span></code></pre></div><p>To run them manually, run</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pre-commit run --all-files
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-e62e32c8f8aaa5c7325bea5a1b00e345>4 - Tutorials and Talks</h1><p>A list of tutorials by the HEIR community. To add to this list, open an issue or
submit a pull request
<a href=https://github.com/google/heir/blob/main/docs/content/en/docs/tutorials.md>on GitHub</a>.</p><h2 id=talks>Talks</h2><ul><li><a href="https://www.youtube.com/watch?v=kqDFdKUTNA4">HEIR: A foundation for FHE compilers (FHE.org 2023-10 meetup)</a></li><li><a href="https://www.youtube.com/watch?v=ne5D_kqlxYg&amp;list=PLnbmMskCVh1fZy00EZQnFSezctvwYmlRM&amp;index=4">How to Write Optimizations in HEIR (FHE.org 2024 conference tutorial)</a>
(<a href="https://docs.google.com/presentation/d/1zRgrkWgLn4FxAWWDTQb8KnS-pqtUbST1AIR8bT_a-E8/edit?usp=sharing">slides</a>)</li></ul><h2 id=mlir-tutorials>MLIR tutorials</h2><ul><li><a href=https://github.com/j2kun/mlir-tutorial/>MLIR for Beginners by Jeremy Kun</a></li></ul><h2 id=fhe-math>FHE math</h2><ul><li><a href=https://jeremykun.com/2022/12/28/estimating-the-security-of-ring-learning-with-errors-rlwe/>Estimating the Security of Ring Learning With Errors by Cathie Yun</a></li><li><a href=https://jeremykun.com/2022/08/29/key-switching-in-lwe/>Key Switching in LWE by Jeremy Kun</a></li><li><a href=https://jeremykun.com/2022/07/16/modulus-switching-in-lwe/>Modulus Switching in LWE by Jeremy Kun</a></li><li><a href=https://jeremykun.com/2022/12/09/negacyclic-polynomial-multiplication/>Negacyclic Polynomial Multiplication by Jeremy Kun</a></li><li><a href=https://jeremykun.com/2023/02/27/sample-extraction-from-rlwe-to-lwe/>Sample Extraction from RLWE to LWE by Jeremy Kun</a></li><li><a href=https://jeremykun.com/2021/12/11/the-gadget-decomposition-in-fhe/>The Gadget Decomposition in FHE by Jeremy Kun</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-439f0d1f88fc52920f9828a37ce073a8>5 - Design</h1><p>This section contains documentation on the high level design of the project.
Readers are intended to have basic familiarity with MLIR and FHE.</p></div><div class=td-content><h1 id=pg-bddfea9d49299ca5edc4a07ea06fcc23>5.1 - Data-oblivious Transformations</h1><p>A data-oblivious program is one that decouples data input from program
execution. Such programs exhibit control-flow and memory access patterns that
are independent of their input(s). This programming model, when applied to
encrypted data, is necessary for expressing FHE programs. There are 3 major
transformations applied to convert a conventional program into a data-oblivious
program:</p><h3 id=1-if-transformation>(1) If-Transformation</h3><p>If-operations conditioned on inputs create data-dependent control-flow in
programs. <code>scf.if</code> operations should at least define a &rsquo;then&rsquo; region (true path)
and always terminate with <code>scf.yield</code> even when <code>scf.if</code> doesn&rsquo;t produce a
result. To convert a data-dependent <code>scf.if</code> operation to an equivalent set of
data-oblivious operations in MLIR, we hoist all safely speculatable operations
in the <code>scf.if</code> operation and convert the <code>scf.yield</code> operation to an
<code>arith.select</code> operation. The following code snippet demonstrates an application
of this transformation.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Before applying If-transformation
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@my_function</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%input</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i1</span> <span style=color:#000;font-weight:700>{</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>})</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// Violation: %input is used as a condition causing a data-dependent branch
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>%result</span> <span style=color:#000;font-weight:700>=</span><span style=color:#a40000>`</span><span style=color:#000>%input</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>%a</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>muli <span style=color:#000>%b</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>        scf<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%a</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>}</span> else <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        scf<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%b</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// After applying If-transformation
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@my_function</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%input</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span> <span style=color:#000;font-weight:700>{</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>})</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>(){</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%a</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>muli <span style=color:#000>%b</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%result</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>select <span style=color:#000>%input</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%a</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%b</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>We implement a <code>ConvertIfToSelect</code> pass that transforms operations with
secret-input conditions and with only Pure operations (i.e., operations that
have no memory side effect and are speculatable) in their body. <strong>This
transformation cannot be applied to operations when side effects are present in
only one of the two regions.</strong> Although possible, we currently do not support
transformations for operations where both regions have operations with matching
side effects. When side effects are present, the pass fails.</p><h3 id=2-loop-transformation>(2) Loop-Transformation</h3><p>Loop statements with input-dependent conditions (bounds) and number of
iterations introduce data-dependent branches that violate data-obliviousness. To
convert such loops into a data-oblivious version, we replace input-dependent
conditionals (bounds) with static input-independent parameters (e.g. defining a
constant upper bound), and early-exits with update operations where the value
returned from the loop is selectively updated using conditional predication. In
MLIR, loops are expressed using either <code>affine.for</code>, <code>scf.for</code> or <code>scf.while</code>
operations.</p><blockquote><p>[!NOTE] Early exiting from loops is not supported in <code>scf</code> and <code>affine</code>, so
early exits are not supported in this pipeline. TODO(#922): support early
exits</p></blockquote><ul><li><code>affine.for</code>: This operation lends itself well to expressing data oblivious
programs because it requires constant loop bounds, eliminating input-dependent
limits.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span> <span style=color:#000>%sum_0</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>0.0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>f32</span>
</span></span><span style=display:flex><span> <span style=color:#8f5902;font-style:italic>// The for-loop&#39;s bound is a fixed constant
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span> <span style=color:#000>%sum</span> <span style=color:#000;font-weight:700>=</span> affine<span style=color:#000;font-weight:700>.</span>for <span style=color:#000>%i</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span> to <span style=color:#0000cf;font-weight:700>10</span> step <span style=color:#0000cf;font-weight:700>2</span>
</span></span><span style=display:flex><span> iter_args<span style=color:#000;font-weight:700>(</span><span style=color:#000>%sum_iter</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>%sum_0</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>f32</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>%t</span> <span style=color:#000;font-weight:700>=</span> affine<span style=color:#000;font-weight:700>.</span>load <span style=color:#000>%buffer</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%i</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>memref</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>1024x</span><span style=color:#204a87;font-weight:700>f32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#000>%sum_next</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addf <span style=color:#000>%sum_iter</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%input</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>f32</span>
</span></span><span style=display:flex><span>   affine<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%sum_next</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>f32</span>
</span></span><span style=display:flex><span> <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span> <span style=color:#000;font-weight:700>...</span>
</span></span></code></pre></div><ul><li><code>scf.for</code>: In contrast to affine.for, scf.for does allow input-dependent
conditionals which does not adhere to data-obliviousness constraints. A
solution to this could be to either have the programmer or the compiler
specify an input-independent upper bound so we can transform the loop to use
this upper bound and also carefully update values returned from the for-loop
using conditional predication. Our current solution to this is for the
programmer to add the lower bound and worst case upper bound in the static
affine loop&rsquo;s <code>attributes</code> list.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@my_function</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%value</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span> <span style=color:#000;font-weight:700>{</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>},</span> <span style=color:#000>%inputIndex</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>index</span> <span style=color:#000;font-weight:700>{</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>})</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#204a87;font-weight:700>i32</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// Violation: for-loop uses %inputIndex as upper bound which causes a secret-dependent control-flow
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>%result</span> <span style=color:#000;font-weight:700>=</span> scf<span style=color:#000;font-weight:700>.</span>for <span style=color:#000>%iv</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>%begin</span> to <span style=color:#000>%inputIndex</span> step <span style=color:#000>%step_value</span> iter_args<span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>%value</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#204a87;font-weight:700>i32</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%output</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>muli <span style=color:#000>%arg1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    scf<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%output</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}{</span><span style=color:#f57900>lower =</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>upper =</span> <span style=color:#0000cf;font-weight:700>32</span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// After applying Loop-Transformation
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@my_function</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%value</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span> <span style=color:#000;font-weight:700>{</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>},</span> <span style=color:#000>%inputIndex</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>index</span> <span style=color:#000;font-weight:700>{</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>})</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#204a87;font-weight:700>i32</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// Build for-loop using lower and upper values from the `attributes` list
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>%result</span> <span style=color:#000;font-weight:700>=</span> affine<span style=color:#000;font-weight:700>.</span>for <span style=color:#000>%iv</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span> to  step <span style=color:#0000cf;font-weight:700>32</span> iter_args<span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>%value</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#204a87;font-weight:700>i32</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%output</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>muli <span style=color:#000>%arg1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%agr1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%cond</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>cmpi eq<span style=color:#000;font-weight:700>,</span> <span style=color:#000>%iv</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%inputIndex</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>index</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%newOutput</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>select <span style=color:#000>%cond</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%output</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg1</span>
</span></span><span style=display:flex><span>    scf<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%newOutput</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><ul><li><code>scf.while</code>: This operation represents a generic while/do-while loop that
keeps iterating as long as a condition is met. An input-dependent while
condition introduces a data-dependent control flow that violates
data-oblivious constraints. For this transformation, the programmer needs to
add the <code>max_iter</code> attribute that describes the maximum number of iterations
the loop runs which we then use the value to build our static <code>affine.for</code>
loop.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Before applying Loop-Transformation
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@my_function</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%input</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span> <span style=color:#000;font-weight:700>{</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>}){</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%zero</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%result</span> <span style=color:#000;font-weight:700>=</span> scf<span style=color:#000;font-weight:700>.</span>while <span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>%input</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#204a87;font-weight:700>i16</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%cond</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>cmpi slt<span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%zero</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Violation: scf.while uses %cond whose value depends on %input
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    scf<span style=color:#000;font-weight:700>.</span>condition<span style=color:#000;font-weight:700>(</span><span style=color:#000>%cond</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>%arg1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span> do <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f57900>^bb0</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%mul</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>muli <span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>    scf<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%mul</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span> attributes <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>max_iter =</span> <span style=color:#0000cf;font-weight:700>16</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i64</span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>return</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// After applying Loop-Transformation
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@my_function</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%input</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span> <span style=color:#000;font-weight:700>{</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>}){</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%zero</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%begin</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>index</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// Replace while-loop with a for-loop with a constant bound %MAX_ITER
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>%result</span> <span style=color:#000;font-weight:700>=</span> affine<span style=color:#000;font-weight:700>.</span>for <span style=color:#000>%iv</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>%0</span> to <span style=color:#000>%16</span> step <span style=color:#000>%step_value</span> iter_args<span style=color:#000;font-weight:700>(</span><span style=color:#000>%iter_arg</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>%input</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#204a87;font-weight:700>i16</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%cond</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>cmpi slt<span style=color:#000;font-weight:700>,</span> <span style=color:#000>%iter_arg</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%zero</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%mul</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>muli <span style=color:#000>%iter_arg</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%iter_arg</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%output</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>select <span style=color:#000>%cond</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%mul</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%iter_arg</span>
</span></span><span style=display:flex><span>    scf<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%output</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}{</span><span style=color:#f57900>max_iter =</span> <span style=color:#0000cf;font-weight:700>16</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i64</span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>return</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=3-access-transformation>(3) Access-Transformation</h3><p>Input-dependent memory access cause data-dependent memory footprints. A naive
data-oblivious solution to this maybe doing read-write operations over the
entire data structure while only performing the desired save/update operation
for the index of interest. For simplicity, we only look at load/store operations
for tensors as they are well supported structures in high-level MLIR likely
emitted by most frontends. We drafted the following non-SIMD approach for this
transformation and defer SIMD optimizations to the <code>heir-simd-vectorizer</code> pass:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Before applying Access Transformation
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@my_function</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%input</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>},</span> <span style=color:#000>%inputIndex</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>index</span> <span style=color:#000;font-weight:700>{</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>})</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%c_10</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>10</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// Violation: tensor.extract loads value at %inputIndex
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>%extractedValue</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>.</span>extract <span style=color:#000>%input</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%inputIndex</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%newValue</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%extractedValue</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c_10</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// Violation: tensor.insert stores value at %inputIndex
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>%inserted</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>.</span>insert <span style=color:#000>%newValue</span> into <span style=color:#000>%input</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%inputIndex</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// After applying Non-SIMD Access Transformation
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@my_function</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%input</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>},</span> <span style=color:#000>%inputIndex</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>index</span> <span style=color:#000;font-weight:700>{</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>})</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%c_10</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>10</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%i_0</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>index</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%dummyValue</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#000>%extractedValue</span> <span style=color:#000;font-weight:700>=</span> affine<span style=color:#000;font-weight:700>.</span>for <span style=color:#000>%i</span><span style=color:#000;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span> to <span style=color:#0000cf;font-weight:700>16</span> iter_args<span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg</span><span style=color:#000;font-weight:700>=</span> <span style=color:#000>%dummyValue</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 1. Check if %i matches %inputIndex
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 2. Extract value at %i
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 3. If %i matches %inputIndex, select %value extracted in (2), else select %dummyValue
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 4. Yield selected value
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>%cond</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>cmpi eq<span style=color:#000;font-weight:700>,</span> <span style=color:#000>%i</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%inputIndex</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>index</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%value</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>.</span>extract <span style=color:#000>%input</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%i</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%selected</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>select <span style=color:#000>%cond</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%value</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%dummyValue</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    affine<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%selected</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#000>%newValue</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%extractedValue</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c_10</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#000>%inserted</span> <span style=color:#000;font-weight:700>=</span> affine<span style=color:#000;font-weight:700>.</span>for <span style=color:#000>%i</span><span style=color:#000;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span> to <span style=color:#0000cf;font-weight:700>16</span> iter_args<span style=color:#000;font-weight:700>(</span><span style=color:#000>%inputArg</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>%input</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 1. Check if %i matches the %inputIndex
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 2. Insert %newValue and produce %newTensor
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 3. If %i matches %inputIndex, select %newTensor, else select input tensor
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 4. Yield final tensor
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>%cond</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>cmpi eq<span style=color:#000;font-weight:700>,</span> <span style=color:#000>%i</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%inputIndex</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>index</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%newTensor</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>.</span>insert <span style=color:#000>%value</span> into <span style=color:#000>%inputArg</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%i</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%finalTensor</span><span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>select <span style=color:#000>%cond</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%newTensor</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%inputArg</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    affine<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%finalTensor</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=more-notes-on-these-transformations>More notes on these transformations</h3><p>These 3 transformations have a cascading behavior where transformations can be
applied progressively to achieve a data-oblivious program. The order of the
transformations goes as follows:</p><ul><li><em>Access-Transformation</em> (change data-dependent tensor accesses (reads-writes)
to use <code>affine.for</code> and <code>scf.if</code> operations) -> <em>Loop-Transformation</em> (change
data-dependent loops to use constant bounds and condition the loop&rsquo;s yield
results with <code>scf.if</code> operation) -> <em>If-Transformation</em> (substitute
data-dependent conditionals with <code>arith.select</code> operation).</li><li>Besides that, when we apply non-SIMD Access-Transformation on multiple
data-dependent tensor read-write operations over the same tensor, we can
benefit from upstream affine transformations over the resulting multiple
affine loops produced by the Access-Transformation to fuse these loops.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-76ae4da46c68c5cd44ad0ecf5d69993f>5.2 - Secret</h1><p>The <a href=https://heir.dev/docs/dialects/secret/><code>secret</code> dialect</a> contains types
and operations to represent generic computations on secret data. It is intended
to be a high-level entry point for the HEIR compiler, agnostic of any particular
FHE scheme.</p><p>Most prior FHE compiler projects design their IR around a specific FHE scheme,
and provide dedicated IR types for the secret analogues of existing data types,
and/or dedicated operations on secret data types. For example, the Concrete
compiler has <code>!FHE.eint&lt;32></code> for an encrypted 32-bit integer, and <code>add_eint</code> and
similar ops. HECO has <code>!fhe.secret&lt;T></code> that models a generic secret type, but
similarly defines <code>fhe.add</code> and <code>fhe.multiply</code>, and other projects are similar.</p><p>The problem with this approach is that it is difficult to incorporate the apply
upstream canonicalization and optimization passes to these ops. For example, the
<code>arith</code> dialect in MLIR has
<a href=https://sourcegraph.com/github.com/llvm/llvm-project@0ab3f160c4bff1c7d57c046b95ab8c5035ae986f/-/blob/mlir/lib/Dialect/Arith/IR/ArithCanonicalization.td>canonicalization patterns</a>
that must be replicated to apply to FHE analogues. One of the goals of HEIR is
to reuse as much upstream infrastructure as possible, and so this led us to
design the <code>secret</code> dialect to have both generic types and generic computations.
Thus, the <code>secret</code> dialect has two main parts: a <code>secret&lt;T></code> type that wraps any
other MLIR type <code>T</code>, and a <code>secret.generic</code> op that lifts any computation on
cleartext to the &ldquo;corresponding&rdquo; computation on secret data types.</p><h2 id=overview-with-bgv-style-lowering-pipeline>Overview with BGV-style lowering pipeline</h2><p>Here is an example of a program that uses <code>secret</code> to lift a dot product
computation:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@dot_product</span><span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;,</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%arg1</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%c0_i16</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> secret<span style=color:#000;font-weight:700>.</span>generic ins<span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;,</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f57900>^bb0</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#000>%arg3</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;):</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> affine<span style=color:#000;font-weight:700>.</span>for <span style=color:#000>%arg4</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span> to <span style=color:#0000cf;font-weight:700>8</span> iter_args<span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg5</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>%c0_i16</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%extracted</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>.</span>extract <span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%arg4</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%extracted_0</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>.</span>extract <span style=color:#000>%arg3</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%arg4</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>muli <span style=color:#000>%extracted</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%extracted_0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%3</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%arg5</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%2</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>      affine<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%3</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    secret<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>The operands to the <code>generic</code> op are the secret data types, and the op contains
a single region, whose block arguments are the corresponding cleartext data
values. Then the region is free to perform any computation, and the values
passed to <code>secret.yield</code> are lifted back to <code>secret</code> types. Note that
<code>secret.generic</code> is not isolated from its enclosing scope, so one may refer to
cleartext SSA values without adding them as generic operands and block
arguments.</p><p>Clearly <code>secret.generic</code> does not actually do anything. It is not decrypting
data. It is merely describing the operation that one wishes to apply to the
secret data in more familiar terms. It is a structural operation, primarily used
to demarcate which operations involve secret operands and have secret results,
and group them for later optimization. The benefit of this is that one can write
optimization passes on types and ops that are not aware of <code>secret</code>, and they
will naturally match on the bodies of <code>generic</code> ops.</p><p>For example, here is what the above dot product computation looks like after
applying the <code>-cse -canonicalize -heir-simd-vectorizer</code> passes, the
implementations of which do not depend on <code>secret</code> or <code>generic</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@dot_product</span><span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;,</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%arg1</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%c1</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>index</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%c2</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>index</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%c4</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>4</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>index</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%c7</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>7</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>index</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> secret<span style=color:#000;font-weight:700>.</span>generic ins<span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;,</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f57900>^bb0</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#000>%arg3</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;):</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>muli <span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg3</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span>_ext<span style=color:#000;font-weight:700>.</span>rotate <span style=color:#000>%1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c4</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#204a87;font-weight:700>index</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%3</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%2</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%4</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span>_ext<span style=color:#000;font-weight:700>.</span>rotate <span style=color:#000>%3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c2</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#204a87;font-weight:700>index</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%5</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%4</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%6</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span>_ext<span style=color:#000;font-weight:700>.</span>rotate <span style=color:#000>%5</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#204a87;font-weight:700>index</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%7</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%5</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%6</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%extracted</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>.</span>extract <span style=color:#000>%7</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%c7</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    secret<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%extracted</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>The canonicalization patterns for <code>secret.generic</code> apply a variety of
simplifications, such as:</p><ul><li>Removing any unused or non-secret arguments and return values.</li><li>Hoisting operations in the body of a <code>generic</code> that only depend on cleartext
values to the enclosing scope.</li><li>Removing any <code>generic</code> ops that use no secrets at all.</li></ul><p>These can be used together with the
<a href=https://heir.dev/docs/passes/secretpasses/#-secret-distribute-generic><code>secret-distribute-generic</code> pass</a>
to split an IR that contains a large <code>generic</code> op into <code>generic</code> ops that
contain a single op, which can then be lowered to a particular FHE scheme
dialect with dedicated ops. This makes lowering easier because it gives direct
access to the secret version of each type that is used as input to an individual
op.</p><p>As an example, a single-op secret might look like this (taken from the larger
example below. Note the use of a cleartext from the enclosing scope, and the
proximity of the secret type to the op to be lowered.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span>  <span style=color:#000>%c2</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>index</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%3</span> <span style=color:#000;font-weight:700>=</span> secret<span style=color:#000;font-weight:700>.</span>generic ins<span style=color:#000;font-weight:700>(</span><span style=color:#000>%2</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f57900>^bb0</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;):</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%8</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span>_ext<span style=color:#000;font-weight:700>.</span>rotate <span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c2</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#204a87;font-weight:700>index</span>
</span></span><span style=display:flex><span>    secret<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%8</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;</span>
</span></span></code></pre></div><p>For a larger example, applying <code>--secret-distribute-generic --canonicalize</code> to
the IR above:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@dot_product</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;,</span> <span style=color:#000>%arg1</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%c1</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>index</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%c2</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>index</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%c4</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>4</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>index</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%c7</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>7</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>index</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> secret<span style=color:#000;font-weight:700>.</span>generic ins<span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;,</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f57900>^bb0</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#000>%arg3</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;):</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%8</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>muli <span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg3</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    secret<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%8</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> secret<span style=color:#000;font-weight:700>.</span>generic ins<span style=color:#000;font-weight:700>(</span><span style=color:#000>%0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f57900>^bb0</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;):</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%8</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span>_ext<span style=color:#000;font-weight:700>.</span>rotate <span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c4</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#204a87;font-weight:700>index</span>
</span></span><span style=display:flex><span>    secret<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%8</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> secret<span style=color:#000;font-weight:700>.</span>generic ins<span style=color:#000;font-weight:700>(</span><span style=color:#000>%0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;,</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f57900>^bb0</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#000>%arg3</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;):</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%8</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg3</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    secret<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%8</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%3</span> <span style=color:#000;font-weight:700>=</span> secret<span style=color:#000;font-weight:700>.</span>generic ins<span style=color:#000;font-weight:700>(</span><span style=color:#000>%2</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f57900>^bb0</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;):</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%8</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span>_ext<span style=color:#000;font-weight:700>.</span>rotate <span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c2</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#204a87;font-weight:700>index</span>
</span></span><span style=display:flex><span>    secret<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%8</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%4</span> <span style=color:#000;font-weight:700>=</span> secret<span style=color:#000;font-weight:700>.</span>generic ins<span style=color:#000;font-weight:700>(</span><span style=color:#000>%2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%3</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;,</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f57900>^bb0</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#000>%arg3</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;):</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%8</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg3</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    secret<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%8</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%5</span> <span style=color:#000;font-weight:700>=</span> secret<span style=color:#000;font-weight:700>.</span>generic ins<span style=color:#000;font-weight:700>(</span><span style=color:#000>%4</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f57900>^bb0</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;):</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%8</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span>_ext<span style=color:#000;font-weight:700>.</span>rotate <span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#204a87;font-weight:700>index</span>
</span></span><span style=display:flex><span>    secret<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%8</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%6</span> <span style=color:#000;font-weight:700>=</span> secret<span style=color:#000;font-weight:700>.</span>generic ins<span style=color:#000;font-weight:700>(</span><span style=color:#000>%4</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%5</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;,</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f57900>^bb0</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#000>%arg3</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;):</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%8</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg3</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    secret<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%8</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%7</span> <span style=color:#000;font-weight:700>=</span> secret<span style=color:#000;font-weight:700>.</span>generic ins<span style=color:#000;font-weight:700>(</span><span style=color:#000>%6</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f57900>^bb0</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;):</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%extracted</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>.</span>extract <span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%c7</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    secret<span style=color:#000;font-weight:700>.</span>yield <span style=color:#000>%extracted</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>%7</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>And then lowering it to <code>bgv</code> with <code>--secret-to-bgv="poly-mod-degree=8"</code> (the
pass option matches the tensor size, but it is an unrealistic FHE polynomial
degree used here just for demonstration purposes). Note type annotations on ops
are omitted for brevity.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span><span style=color:#000>#encoding</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>#lwe.polynomial_evaluation_encoding</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>cleartext_start =</span> <span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>cleartext_bitwidth =</span> <span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>#params</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>#lwe.rlwe_params</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>ring =</span> <span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>cmod=</span><span style=color:#0000cf;font-weight:700>463187969</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>ideal=</span><span style=color:#000>#_polynomial.polynomial</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#a40000>+</span> <span style=color:#000;font-weight:700>x**</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>&gt;&gt;&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>!</span><span style=color:#f57900>ty1 =</span> <span style=color:#000;font-weight:700>!</span>lwe<span style=color:#000;font-weight:700>.</span>rlwe_ciphertext<span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>encoding=</span><span style=color:#000>#encoding</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>rlwe_params=</span><span style=color:#000>#params</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>underlying_type=</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>!</span><span style=color:#f57900>ty2 =</span> <span style=color:#000;font-weight:700>!</span>lwe<span style=color:#000;font-weight:700>.</span>rlwe_ciphertext<span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>encoding=</span><span style=color:#000>#encoding</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>rlwe_params=</span><span style=color:#000>#params</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>underlying_type=</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@dot_product</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>ty1<span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg1</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>ty1<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>ty2 <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%c1</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>index</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%c2</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>index</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%c4</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>4</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>index</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%c7</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>7</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>index</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> bgv<span style=color:#000;font-weight:700>.</span>mul <span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg1</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> bgv<span style=color:#000;font-weight:700>.</span>relinearize <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>from_basis =</span> array<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#f57900>to_basis =</span> array<span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>&gt;}</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> bgv<span style=color:#000;font-weight:700>.</span>rotate <span style=color:#000>%1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c4</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%3</span> <span style=color:#000;font-weight:700>=</span> bgv<span style=color:#000;font-weight:700>.</span>add <span style=color:#000>%1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%2</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%4</span> <span style=color:#000;font-weight:700>=</span> bgv<span style=color:#000;font-weight:700>.</span>rotate <span style=color:#000>%3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c2</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%5</span> <span style=color:#000;font-weight:700>=</span> bgv<span style=color:#000;font-weight:700>.</span>add <span style=color:#000>%3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%4</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%6</span> <span style=color:#000;font-weight:700>=</span> bgv<span style=color:#000;font-weight:700>.</span>rotate <span style=color:#000>%5</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c1</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%7</span> <span style=color:#000;font-weight:700>=</span> bgv<span style=color:#000;font-weight:700>.</span>add <span style=color:#000>%5</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%6</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%8</span> <span style=color:#000;font-weight:700>=</span> bgv<span style=color:#000;font-weight:700>.</span>extract <span style=color:#000>%7</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c7</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>%8</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h2 id=differences-for-cggi-style-pipeline>Differences for CGGI-style pipeline</h2><p>The <code>tosa-to-boolean-tfhe</code> and related pipelines add a few additional steps. The
main goal here is to apply a hardware circuit optimizer to blocks of standard
MLIR code (inside <code>secret.generic</code> ops) which converts the computation to an
optimized boolean circuit with a desired set of gates. Only then is
<code>-secret-distribute-generic</code> applied to split the ops up and lower them to the
<code>cggi</code> dialect. In particular, because passing an IR through the circuit
optimizer requires unrolling all loops, one useful thing you might want to do is
to optimize only the <em>body</em> of a for loop nest.</p><p>To accomplish this, we have two additional mechanisms. One is the pass option
<code>ops-to-distribute</code> for <code>-secret-distribute-generic</code>, which allows the user to
specify a list of ops that <code>generic</code> should be split across, and all others left
alone. Specifying <code>affine.for</code> here will pass <code>generic</code> through the <code>affine.for</code>
loop, but leave its body intact. This can also be used with the <code>-unroll-factor</code>
option to the <code>-yosys-optimizer</code> pass to partially unroll a loop nest and pass
the partially-unrolled body through the circuit optimizer.</p><p>The other mechanism is the <code>secret.separator</code> op, which is a purely structural
op that demarcates the boundary of a subset of a block that should be jointly
optimized in the circuit optimizer.</p><p>For example, the following <code>tosa</code> ops lower to multiple linalg instructions, and
hence multiple for loops, that we want to pass to a circuit optimizer as a unit.
The <code>secret.separator</code> ops surrounding the op are preserved through the
lowering.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@main</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>1x1x</span><span style=color:#204a87;font-weight:700>i8</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>})</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>1x16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  secret<span style=color:#000;font-weight:700>.</span>separator
</span></span><span style=display:flex><span>  <span style=color:#000>%4</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#34;tosa.const&#34;</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>value =</span> dense<span style=color:#000;font-weight:700>&lt;[</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>-5438</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>-5515</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>-1352</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>-1500</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>-4152</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>-84</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>3396</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1981</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>-5581</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>-6964</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>3407</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>-7217</span><span style=color:#000;font-weight:700>]&gt;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%5</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#34;tosa.const&#34;</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>value =</span> dense<span style=color:#000;font-weight:700>&lt;[[</span><span style=color:#0000cf;font-weight:700>-9</span><span style=color:#000;font-weight:700>],</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>-54</span><span style=color:#000;font-weight:700>],</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>57</span><span style=color:#000;font-weight:700>],</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>71</span><span style=color:#000;font-weight:700>],</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>104</span><span style=color:#000;font-weight:700>],</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>115</span><span style=color:#000;font-weight:700>],</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>98</span><span style=color:#000;font-weight:700>],</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>99</span><span style=color:#000;font-weight:700>],</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#000;font-weight:700>],</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>-26</span><span style=color:#000;font-weight:700>],</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>127</span><span style=color:#000;font-weight:700>],</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>25</span><span style=color:#000;font-weight:700>],</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>-82</span><span style=color:#000;font-weight:700>],</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>68</span><span style=color:#000;font-weight:700>],</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>95</span><span style=color:#000;font-weight:700>],</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>86</span><span style=color:#000;font-weight:700>]]&gt;</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x1x</span><span style=color:#204a87;font-weight:700>i8</span><span style=color:#000;font-weight:700>&gt;}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x1x</span><span style=color:#204a87;font-weight:700>i8</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%6</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#34;tosa.fully_connected&#34;</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%5</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%4</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>quantization_info =</span> <span style=color:#000>#tosa.conv_quant</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#f57900>input_zp =</span> <span style=color:#0000cf;font-weight:700>-128</span><span style=color:#000;font-weight:700>,</span> <span style=color:#f57900>weight_zp =</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>&gt;}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>1x1x</span><span style=color:#204a87;font-weight:700>i8</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x1x</span><span style=color:#204a87;font-weight:700>i8</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>1x16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  secret<span style=color:#000;font-weight:700>.</span>separator
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>%6</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>tensor</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>1x16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>After running <code>--tosa-to-boolean-tfhe</code> and dumping the IR after the linalg ops
are lowered to loops, we can see the <code>secret.separator</code> ops enclose the lowered
ops, with the exception of some pure ops that are speculatively executed.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@main</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>memref</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>1x1x</span><span style=color:#204a87;font-weight:700>i8</span><span style=color:#000;font-weight:700>,</span> strided<span style=color:#000;font-weight:700>&lt;[</span><span style=color:#a40000>?</span><span style=color:#000;font-weight:700>,</span> <span style=color:#a40000>?</span><span style=color:#000;font-weight:700>],</span> offset<span style=color:#000;font-weight:700>:</span> <span style=color:#a40000>?</span><span style=color:#000;font-weight:700>&gt;&gt;</span> <span style=color:#000;font-weight:700>{</span>secret<span style=color:#000;font-weight:700>.</span>secret<span style=color:#000;font-weight:700>})</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#204a87;font-weight:700>memref</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>1x16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%c</span><span style=color:#0000cf;font-weight:700>-128</span><span style=color:#f57900>_i32 =</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>-128</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>memref</span><span style=color:#000;font-weight:700>.</span>get_global <span style=color:#000>@__constant_16xi32</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>memref</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>memref</span><span style=color:#000;font-weight:700>.</span>get_global <span style=color:#000>@__constant_16x1xi8</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>memref</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x1x</span><span style=color:#204a87;font-weight:700>i8</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  secret<span style=color:#000;font-weight:700>.</span>separator
</span></span><span style=display:flex><span>  <span style=color:#000>%alloc</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>memref</span><span style=color:#000;font-weight:700>.</span>alloc<span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>alignment =</span> <span style=color:#0000cf;font-weight:700>64</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i64</span><span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>memref</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>1x16x</span><span style=color:#204a87;font-weight:700>i8</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  affine<span style=color:#000;font-weight:700>.</span>for <span style=color:#000>%arg1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span> to <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    affine<span style=color:#000;font-weight:700>.</span>for <span style=color:#000>%arg2</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span> to <span style=color:#0000cf;font-weight:700>16</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> affine<span style=color:#000;font-weight:700>.</span>load <span style=color:#000>%1</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg1</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>memref</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x1x</span><span style=color:#204a87;font-weight:700>i8</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>      affine<span style=color:#000;font-weight:700>.</span>store <span style=color:#000>%2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%alloc</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%arg1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>memref</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>1x16x</span><span style=color:#204a87;font-weight:700>i8</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%alloc_0</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>memref</span><span style=color:#000;font-weight:700>.</span>alloc<span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>alignment =</span> <span style=color:#0000cf;font-weight:700>64</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i64</span><span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>memref</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>1x16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  affine<span style=color:#000;font-weight:700>.</span>for <span style=color:#000>%arg1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span> to <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    affine<span style=color:#000;font-weight:700>.</span>for <span style=color:#000>%arg2</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span> to <span style=color:#0000cf;font-weight:700>16</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> affine<span style=color:#000;font-weight:700>.</span>load <span style=color:#000>%0</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>memref</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>      affine<span style=color:#000;font-weight:700>.</span>store <span style=color:#000>%2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%alloc_0</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%arg1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>memref</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>1x16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>  affine<span style=color:#000;font-weight:700>.</span>for <span style=color:#000>%arg1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span> to <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    affine<span style=color:#000;font-weight:700>.</span>for <span style=color:#000>%arg2</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span> to <span style=color:#0000cf;font-weight:700>16</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      affine<span style=color:#000;font-weight:700>.</span>for <span style=color:#000>%arg3</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span> to <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> affine<span style=color:#000;font-weight:700>.</span>load <span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%arg1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg3</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>memref</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>1x1x</span><span style=color:#204a87;font-weight:700>i8</span><span style=color:#000;font-weight:700>,</span> strided<span style=color:#000;font-weight:700>&lt;[</span><span style=color:#a40000>?</span><span style=color:#000;font-weight:700>,</span> <span style=color:#a40000>?</span><span style=color:#000;font-weight:700>],</span> offset<span style=color:#000;font-weight:700>:</span> <span style=color:#a40000>?</span><span style=color:#000;font-weight:700>&gt;&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>%3</span> <span style=color:#000;font-weight:700>=</span> affine<span style=color:#000;font-weight:700>.</span>load <span style=color:#000>%alloc</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%arg3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>memref</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>1x16x</span><span style=color:#204a87;font-weight:700>i8</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>%4</span> <span style=color:#000;font-weight:700>=</span> affine<span style=color:#000;font-weight:700>.</span>load <span style=color:#000>%alloc_0</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%arg1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>memref</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>1x16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>%5</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>extsi <span style=color:#000>%2</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i8</span> to <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>        <span style=color:#000>%6</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>subi <span style=color:#000>%5</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c</span><span style=color:#0000cf;font-weight:700>-128</span>_i32 <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>        <span style=color:#000>%7</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>extsi <span style=color:#000>%3</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i8</span> to <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>        <span style=color:#000>%8</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>muli <span style=color:#000>%6</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%7</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>        <span style=color:#000>%9</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%4</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%8</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>        affine<span style=color:#000;font-weight:700>.</span>store <span style=color:#000>%9</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%alloc_0</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%arg1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%arg2</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>memref</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>1x16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>  secret<span style=color:#000;font-weight:700>.</span>separator
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>memref</span><span style=color:#000;font-weight:700>.</span>dealloc <span style=color:#000>%alloc</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>memref</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>1x16x</span><span style=color:#204a87;font-weight:700>i8</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>%alloc_0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>memref</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>1x16x</span><span style=color:#204a87;font-weight:700>i32</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>We decided to use the <code>separator</code> op over a few alternatives:</p><ul><li>Grouping by <code>secret.generic</code>: these <code>tosa</code> ops must be bufferized, but
<code>secret</code> types cannot participate in bufferization (see the Limitations
section).</li><li>Grouping by basic blocks: <code>secret.generic</code> is a single-block op with a yield
terminator, and grouping by blocks would require us to change this.</li><li>Grouping by regions: SSA values generated by a region are not visible to the
enclosing scope, so we would need to have the region-bearing op return values,
which is tedious to organize.</li><li>Attaching attributes to ops that should be grouped together: this would not be
preserved by upstream lowerings and optimization passes.</li></ul><h2 id=generic-operands><code>generic</code> operands</h2><p><code>secret.generic</code> takes any SSA values as legal operands. They may be <code>secret</code>
types or non-secret. Canonicalizing <code>secret.generic</code> removes non-secret operands
and leaves them to be referenced via the enclosing scope (<code>secret.generic</code> is
not <code>IsolatedFromAbove</code>).</p><p>This may be unintuitive, as one might expect that only secret types are valid
arguments to <code>secret.generic</code>, and that a verifier might assert non-secret args
are not present.</p><p>However, we allow non-secret operands because it provides a convenient scope
encapsulation mechanism, which is useful for the <code>--yosys-optimizer</code> pass that
runs a circuit optimizer on individual <code>secret.generic</code> ops and needs to have
access to all SSA values used as inputs. The following passes are related to
this functionality:</p><ul><li><code>secret-capture-generic-ambient-scope</code></li><li><code>secret-generic-absorb-constants</code></li><li><code>secret-extract-generic-body</code></li></ul><p>Due to the canonicalization rules for <code>secret.generic</code>, anyone using these
passes as an IR organization mechanism must be sure not to canonicalize before
accomplishing the intended task.</p><h2 id=limitations>Limitations</h2><h3 id=bufferization>Bufferization</h3><p>Secret types cannot participate in bufferization passes. In particular,
<code>-one-shot-bufferize</code> hard-codes the notion of tensor and memref types, and so
it cannot currently operate on <code>secret&lt;tensor&lt;...>></code> or <code>secret&lt;memref&lt;...>></code>
types, which prevents us from implementing a bufferization interface for
<code>secret.generic</code>. This was part of the motivation to introduce
<code>secret.separator</code>, because <code>tosa</code> ops like a fully connected neural network
layer lower to multiple linalg ops, and these ops need to be bufferized before
they can be lowered further. However, we want to keep the lowered ops grouped
together for circuit optimization (e.g., fusing transposes and constant weights
into the optimized layer), but because of this limitation, we can&rsquo;t simply wrap
the <code>tosa</code> ops in a <code>secret.generic</code> (bufferization would fail).</p></div><div class=td-content style=page-break-before:always><h1 id=pg-05018faa55dd802660a3ea38b8f7fb69>5.3 - SIMD Optimizations</h1><p>HEIR includes a SIMD (Single Instruction, Multiple Data) optimizer which is
designed to exploit the restricted SIMD parallelism most (Ring-LWE-based) FHE
schemes support (also commonly known as &ldquo;packing&rdquo; or &ldquo;batching&rdquo;). Specifically,
HEIR incorporates the &ldquo;automated batching&rdquo; optimizations (among many other
things) from the <a href=https://github.com/MarbleHE/HECO>HECO</a> compiler. The
following will assume basic familiarity with the FHE SIMD paradigm and the
high-level goals of the optimization, and we refer to the associated HECO
<a href=https://www.usenix.org/system/files/usenixsecurity23-viand.pdf>paper</a>,
<a href=https://www.usenix.org/system/files/sec23_slides_viand.pdf>slides</a>,
<a href="https://www.youtube.com/watch?v=SP3C6gLWIS4">talk</a> and additional resources on
the
<a href=https://www.usenix.org/conference/usenixsecurity23/presentation/viand>Usenix'23 website</a>
for an introduction to the topic. This documentation will mostly focus on
describing how the optimization is realized in HEIR (which differs somewhat from
the original implementation) and how the optimization is intended to be used in
an overall end-to-end compilation pipeline.</p><h2 id=representing-fhe-simd-operations>Representing FHE SIMD Operations</h2><p>Following the design principle of maintaining programs in standard MLIR dialects
as long as possible (cf. the design rationale behind the
<a href=https://heir.dev/docs/design/secret/>Secret Dialect</a>), HEIR uses the MLIR
<a href=https://mlir.llvm.org/docs/Dialects/TensorOps/><code>tensor</code> dialect</a> and
<a href=https://mlir.llvm.org/docs/Traits/#elementwisemappable>ElementwiseMappable</a>
operations from the MLIR
<a href=https://mlir.llvm.org/docs/Dialects/ArithOps/><code>arith</code> dialect</a> to represent HE
SIMD operations.</p><p>We do introduce the HEIR-specific
<a href=https://heir.dev/docs/dialects/tensorext/#tensor_extrotate-heirtensor_extrotateop><code>tensor_ext.rotate</code></a>
operation, which represents a cyclical left-rotation of a tensor. Note that, as
the current SIMD vectorizer only supports one-dimensional tensors, the semantics
of this operation on multi-dimensional tensors are not (currently) defined.</p><p>For example, the common &ldquo;rotate-and-reduce&rdquo; pattern which results in each
element containing the sum/product/etc of the original vector can be expressed
as:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-llvm data-lang=llvm><span style=display:flex><span><span style=color:#000>%tensor</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>from_elements</span> <span style=color:#000>%i1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%i2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%i3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%i4</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%i5</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%i6</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%i7</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%i8</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>tensor_ext</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>rotate</span> <span style=color:#000>%tensor</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c4</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#a40000>inde</span><span style=color:#204a87;font-weight:700>x</span>
</span></span><span style=display:flex><span><span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>arith</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>addi</span> <span style=color:#000>%tensor</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%0</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>tensor_ext</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>rotate</span> <span style=color:#000>%1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c2</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#a40000>inde</span><span style=color:#204a87;font-weight:700>x</span>
</span></span><span style=display:flex><span><span style=color:#000>%3</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>arith</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>addi</span> <span style=color:#000>%1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%2</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>%4</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>tensor_ext</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>rotate</span> <span style=color:#000>%3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c1</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#a40000>inde</span><span style=color:#204a87;font-weight:700>x</span>
</span></span><span style=display:flex><span><span style=color:#000>%5</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>arith</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>addi</span> <span style=color:#000>%3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%4</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span></code></pre></div><p>The <code>%cN</code> and <code>%iN</code>, which are defined as <code>%cN = arith.constant N : index</code> and
<code>%iN = arith.constant N : i16</code>, respectively, have been omitted for readability.</p><h2 id=intended-usage>Intended Usage</h2><p>The <code>-heir-simd-vectorizer</code> pipeline transforms a program consisting of loops
and index-based accesses into tensors (e.g., <code>tensor.extract</code> and
<code>tensor.insert</code>) into one consisting of SIMD operations (including rotations) on
entire tensors. While its implementation does not depend on any FHE-specific
details or even the Secret dialect, this transformation is likely only useful
when lowering a high-level program to an arithmetic-circuit-based FHE scheme
(e.g., B/FV, BGV, or CKKS). The <code>--mlir-to-bgv --scheme-to-openfhe</code> pipeline
demonstrates the intended flow: augmenting a high-level program with <code>secret</code>
annotations, then applying the SIMD optimization (and any other high-level
optimizations) before lowering to BGV operations and then exiting to OpenFHE.</p><blockquote><p><strong>Warning</strong> The current SIMD vectorizer pipeline supports only one-dimensional
tensors. As a workaround, one could reshape all multi-dimensional tensors into
one-dimensional tensors, but MLIR/HEIR currently do not provide a pass to
automate this process.</p></blockquote><p>Since the optimization is based on heuristics, the resulting program might not
be optimal or could even be worse than a trivial realization that does not use
ciphertext packing. However, well-structured programs generally lower to
reasonable batched solutions, even if they do not achieve optimal batching
layouts. For common operations such as matrix-vector or matrix-matrix
multiplications, state-of-the-art approaches require advanced packing schemes
that might map elements into the ciphertext vector in non-trivial ways (e.g.,
diagonal-major and/or replicated). The current SIMD vectorizer will never change
the arrangement of elements inside an input tensor and therefore cannot produce
the optimal approaches for these operations.</p><p>Note, that the SIMD batching optimization is different from, and significantly
more complex than, the Straight Line Vectorizer (<code>-straight-line-vectorize</code>
pass), which simply groups
<a href=https://mlir.llvm.org/docs/Traits/#elementwisemappable>ElementwiseMappable</a>
operations that agree in operation name and operand/result types into
vectorized/tensorized versions.</p><h2 id=implementation>Implementation</h2><p>Below, we give a brief overview over the implementation, with the goal of both
improving maintainability/extensibility of the SIMD vectorizer and allowing
advanced users to better understand why a certain program is transformed in the
way it is.</p><h3 id=components>Components</h3><p>The <code>-heir-simd-vectorizer</code> pipeline uses a combination of standard MLIR passes
(<a href=https://mlir.llvm.org/docs/Passes/#-canonicalize><code>-canonicalize</code></a>,
<a href=https://mlir.llvm.org/docs/Passes/#-cse><code>-cse</code></a>,
<a href=https://mlir.llvm.org/docs/Passes/#-sccp><code>-sccp</code></a>) and custom HEIR passes.
Some of these
(<a href=https://heir.dev/docs/passes/applyfolderspasses/#-apply-folders><code>-apply-folders</code></a>,
<a href=https://heir.dev/docs/passes/fullloopunrollpasses/#-full-loop-unroll><code>-full-loop-unroll</code></a>)
might have applications outside the SIMD optimization, while others
(<a href=https://heir.dev/docs/passes/tensorextpasses/#-insert-rotate><code>-insert-rotate</code></a>,
<a href=https://heir.dev/docs/passes/tensorextpasses/#-collapse-insertion-chains><code>-collapse-insertion-chains</code></a>
and
<a href=https://heir.dev/docs/passes/tensorextpasses/#-rotate-and-reduce><code>-rotate-and-reduce</code></a>)
are very specific to the FHE SIMD optimization. In addition, the passes make use
of the <code>RotationAnalysis</code> and <code>TargetSlotAnalysis</code> analyses.</p><h3 id=high-level-flow>High-Level Flow</h3><ul><li><p><strong>Loop Unrolling</strong> (<code>-full-loop-unroll</code>): The implementation currently begins
by unrolling all loops in the program to simplify the later passes. See
<a href=https://github.com/google/heir/issues/589>#589</a> for a discussion on how this
could be avoided.</p></li><li><p><strong>Canonicalization</strong> (<code>-apply-folders -canonicalize</code>): As the
rotation-specific passes are very strict about the structure of the IR they
operate on, we must first simplify away things such as tensors of constant
values. For performance reasons (c.f. comments in the
<code>heirSIMDVectorizerPipelineBuilder</code> function in <code>heir-opt.cpp</code>), this must be
done by first applying
<a href=https://mlir.llvm.org/docs/Canonicalization/#canonicalizing-with-the-fold-method>folds</a>
before applying the full
<a href=https://mlir.llvm.org/docs/Canonicalization/>canonicalization</a>.</p></li><li><p><strong>Main SIMD Rewrite</strong> (<code>-insert-rotate -cse -canonicalize -cse</code>): This pass
rewrites arithmetic operations over <code>tensor.extract</code>-ed operands into SIMD
operations over the entire tensor, rotating the (full-tensor) operands so that
the correct elements interact. For example, it will rewrite the following
snippet (which computes <code>t2[4] = t0[3] + t1[5]</code>)</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-llvm data-lang=llvm><span style=display:flex><span><span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>extract</span> <span style=color:#000>%t0</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%c3</span><span style=color:#000;font-weight:700>]</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>extract</span> <span style=color:#000>%t1</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%c5</span><span style=color:#000;font-weight:700>]</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>arith</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>addi</span> <span style=color:#000>%0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%1</span> <span style=color:#a40000>:</span> <span style=color:#204a87;font-weight:700>i16</span>
</span></span><span style=display:flex><span><span style=color:#000>%3</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>insert</span> <span style=color:#000>%2</span> <span style=color:#a40000>in</span><span style=color:#204a87;font-weight:700>to</span> <span style=color:#000>%t2</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%c4</span><span style=color:#000;font-weight:700>]</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span></code></pre></div><p>to</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-llvm data-lang=llvm><span style=display:flex><span><span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>tensor_ext</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>rotate</span> <span style=color:#000>%t0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c31</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#a40000>inde</span><span style=color:#204a87;font-weight:700>x</span>
</span></span><span style=display:flex><span><span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>tensor_ext</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>rotate</span> <span style=color:#000>%t1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c1</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;,</span> <span style=color:#a40000>inde</span><span style=color:#204a87;font-weight:700>x</span>
</span></span><span style=display:flex><span><span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>arith</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>addi</span> <span style=color:#000>%0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%1</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span></code></pre></div><p>i.e., rotating <code>t0</code> down by one (31 = -1 (mod 32)) and <code>t1</code> up by one to bring
the elements at index 3 and 5, respectively, to the &ldquo;target&rdquo; index 4. The pass
uses the <code>TargetSlotAnalysis</code> to identify the appropriate target index (or
ciphertext &ldquo;slot&rdquo; in FHE-speak). See <a href=#insert-rotate-pass>Insert Rotate Pass</a>
below for more details. This pass is roughly equivalent to the <code>-batching</code>
pass in the original HECO implementation.</p><p>Doing this rewrite by itself does not represent an optimization, but if we
consider what happens to the corresponding code for other indices (e.g.,
<code>t2[5] = t0[4] + t1[6]</code>), we see that the pass transforms expressions with the
same relative index offsets into the exact same set of rotations/SIMD
operations, so the following
<a href=https://en.wikipedia.org/wiki/Common_subexpression_elimination>Common Subexpression Elimination (CSE)</a>
will remove redundant computations. We apply CSE twice, once directly (which
creates new opportunities for canonicalization and folding) and then again
after that canonicalization. See
<a href=#tensorext-canonicalization>TensorExt Canonicalization</a> for a description of
the rotation-specific canonocalization patterns).</p></li><li><p><strong>Cleanup of Redundant Insert/Extract</strong>
(<code>-collapse-insertion-chains -sccp -canonicalize -cse</code>): Because the
<code>-insert-rotate</code> pass maintains the consistency of the IR, it emits a
<code>tensor.extract</code> operation after the SIMD operation and uses that to replace
the original operation (which is valid, as both produce the desired scalar
result). As a consequence, the generated code for the snippet above is
actually trailed by a (redundant) extract/insert:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-llvm data-lang=llvm><span style=display:flex><span><span style=color:#000>%extracted</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>extract</span> <span style=color:#000>%2</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%c4</span><span style=color:#000;font-weight:700>]</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000>%inserted</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>insert</span> <span style=color:#000>%extracted</span> <span style=color:#a40000>in</span><span style=color:#204a87;font-weight:700>to</span> <span style=color:#000>%t2</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>%c4</span><span style=color:#000;font-weight:700>]</span> <span style=color:#a40000>:</span> <span style=color:#a40000>tens</span><span style=color:#204a87;font-weight:700>or</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#a40000>x</span><span style=color:#204a87;font-weight:700>i16</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span></code></pre></div><p>In real code, this might generate a long series of such extraction/insertion
operations, all extracting from the same (due to CSE) tensor and inserting
into the same output tensor. Therefore, the <code>-collapse-insertion-chains</code> pass
searches for such chains over entire tensors and collapses them. It supports
not just chains where the indices match perfectly, but any chain where the
relative offset is consistent across the tensor, issuing a rotation to realize
the offset (if the offset is zero, the canonicalization will remove the
redundant rotation). Note, that in HECO, insertion/extraction is handled
differently, as HECO features a <code>combine</code> operation modelling not just simple
insertions (<code>combine(%t0#j, %t1)</code>) but also more complex operations over
slices of tensors (<code>combine(%t0#[i,j], %t1)</code>). As a result, the equivalent
pass in HECO (<code>-combine-simplify</code>) instead joins different <code>combine</code>
operations, and a later fold removes <code>combines</code> that replace the entire target
tensor. See issue <a href=https://github.com/google/heir/issues/512>#512</a> for a
discussion on why the <code>combine</code> operation is a more powerful framework and
what would be necessary to port it to HEIR.</p></li><li><p><strong>Applying Rotate-and-Reduce Patterns</strong>
(<code>-rotate-and-reduce -sccp -canonicalize -cse</code>): The rotate and reduce pattern
(see <a href=#representing-fhe-simd-operations>Representing FHE SIMD Operations</a> for
an example) is an important aspect of accelerating SIMD-style operations in
FHE, but it does not follow automatically from the batching rewrites applied
so far. As a result, the <code>-rotate-and-reduce</code> pass needs to search for
sequences of arithmetic operations that correspond to the full folding of a
tensor, i.e., patterns such as <code>t[0]+(t[1]+(t[2]+t[3]+(...)))</code>, which
currently uses a backwards search through the IR, but could be achieved more
efficiently through a data flow analysis (c.f. issue
<a href=https://github.com/google/heir/issues/523>#532</a>). In HECO, rotate-and-reduce
is handled differently, by identifying sequences of compatible operations
prior to batching and rewriting them to &ldquo;n-ary&rdquo; operations. However, this
approach requires non-standard arithmetic operations and is therefore not
suitable for use in HEIR. However, there is likely still an opportunity to
make the patterns in HEIR more robust/general (e.g., support constant scalar
operands in the fold, or support non-full-tensor folds). See issue
<a href=https://github.com/google/heir/issues/522>#522</a> for ideas on how to make the
HEIR pattern more robust/more general.</p></li></ul><h3 id=insert-rotate-pass>Insert Rotate Pass</h3><p>TODO(#721): Write a detailed description of the rotation insertion pass and the
associated target slot analysis.</p><h3 id=tensorext-canonicalization>TensorExt Canonicalization</h3><p>The
<a href=https://heir.dev/docs/dialects/tensorext/>TensorExt (<code>tensor_ext</code>) Dialect</a>
includes a series of canonicalization rules that are essential to making
automatically generated rotation code efficient:</p><ul><li><p>Rotation by zero: <code>rotate %t, 0</code> folds away to <code>%t</code></p></li><li><p>Cyclical wraparound: <code>rotate %t, k</code> for $k > t.size$ can be simplified to
<code>rotate %t, (k mod t.size)</code></p></li><li><p>Sequential rotation: <code>%0 = rotate %t, k</code> followed by <code>%1 = rotate %0, l</code> is
simplified to <code>rotate %t (k+l)</code></p></li><li><p>Extraction: <code>%0 = rotate %t, k</code> followed by <code>%1 = tensor.extract %0[l]</code> is
simplified to <code>tensor.extract %t[k+l]</code></p></li><li><p>Binary Arithmetic Ops: where both operands to a binary <code>arith</code> operation are
rotations by the same amount, the rotation can be performed only once, on the
result. For Example,</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-llvm data-lang=llvm><span style=display:flex><span><span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>rotate</span> <span style=color:#000>%t1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#a40000>k</span>
</span></span><span style=display:flex><span><span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>rotate</span> <span style=color:#000>%t2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#a40000>k</span>
</span></span><span style=display:flex><span><span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>arith</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>add</span> <span style=color:#000>%0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%1</span>
</span></span></code></pre></div><p>can be simplified to</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-llvm data-lang=llvm><span style=display:flex><span><span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>arith</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>add</span> <span style=color:#000>%t1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%t2</span>
</span></span><span style=display:flex><span><span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>rotate</span> <span style=color:#000>%0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#a40000>k</span>
</span></span></code></pre></div></li><li><p><em>Sandwiched</em> Binary Arithmetic Ops: If a rotation follows a binary <code>arith</code>
operation which has rotation as its operands, the post-arith operation can be
moved forward. For example,</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-llvm data-lang=llvm><span style=display:flex><span><span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>rotate</span> <span style=color:#000>%t1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>x</span>
</span></span><span style=display:flex><span><span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>rotate</span> <span style=color:#000>%t2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#a40000>y</span>
</span></span><span style=display:flex><span><span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>arith</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>add</span> <span style=color:#000>%0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%1</span>
</span></span><span style=display:flex><span><span style=color:#000>%3</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>rotate</span> <span style=color:#000>%2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#a40000>z</span>
</span></span></code></pre></div><p>can be simplified to</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-llvm data-lang=llvm><span style=display:flex><span><span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>rotate</span> <span style=color:#000>%t1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>x</span> <span style=color:#a40000>+</span> <span style=color:#a40000>z</span>
</span></span><span style=display:flex><span><span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>rotate</span> <span style=color:#000>%t2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#a40000>y</span> <span style=color:#a40000>+</span> <span style=color:#a40000>z</span>
</span></span><span style=display:flex><span><span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>arith</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>add</span> <span style=color:#000>%0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%1</span>
</span></span></code></pre></div></li><li><p>Single-Use Arithmetic Ops: Finally, there is a pair of rules that do not
eliminate rotations, but move rotations up in the IR, which can help in
exposing further canonicalization and/or CSE opportunities. These only apply
to <code>arith</code> operations with a single use, as they might otherwise increase the
total number of rotations. For example,</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-llvm data-lang=llvm><span style=display:flex><span><span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>rotate</span> <span style=color:#000>%t1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#a40000>k</span>
</span></span><span style=display:flex><span><span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>arith</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>add</span> <span style=color:#000>%0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%t2</span>
</span></span><span style=display:flex><span><span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>rotate</span> <span style=color:#000>%2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#a40000>l</span>
</span></span></code></pre></div><p>can be equivalently rewritten as</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-llvm data-lang=llvm><span style=display:flex><span><span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>rotate</span> <span style=color:#000>%t1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>(</span><span style=color:#a40000>k+l</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>rotate</span> <span style=color:#000>%t2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#a40000>l</span>
</span></span><span style=display:flex><span><span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>arith</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>add</span> <span style=color:#000>%0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%1</span>
</span></span></code></pre></div><p>and a similar pattern exists for situations where the rotation is the rhs
operand of the arithmetic operation.</p></li></ul><p>Note that the index computations in the patterns above (e.g., <code>k+l</code>,
<code>k mod t.size</code> are realized via emitting <code>arith</code> operations. However, for
constant/compile-time-known indices, these will be subsequently constant-folded
away by the canonicalization pass.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-cd22aa05be277ba6c2e2f8f083706b51>5.4 - Optimizing relinearization</h1><p>This document outlines the integer linear program model used in the
<a href=https://heir.dev/docs/passes/optimizerelinearizationpasses/#-optimize-relinearization><code>optimize-relinearization</code></a>
pass.</p><h2 id=background>Background</h2><p>In vector/arithmetic FHE, RLWE ciphertexts often have the form $\mathbf{c} =
(c_0, c_1)$, where the details of how $c_0$ and $c_1$ are computed depend on the
specific scheme. However, in most of these schemes, the process of decryption
can be thought of as taking a dot product between the vector $\mathbf{c}$ and a
vector $(1, s)$ containing the secret key $s$ (followed by rounding).</p><p>In such schemes, the homomorphic multiplication of two ciphertexts $\mathbf{c}
= (c_0, c_1)$ and $\mathbf{d} = (d_0, d_1)$ produces a ciphertext $\mathbf{f}
= (f_0, f_1, f_2)$. This triple can be decrypted by taking a dot product with
$(1, s, s^2)$.</p><p>With this in mind, each RLWE ciphertext $\mathbf{c}$ has an associated <em>key
basis</em>, which is the vector $\mathbf{s_c}$ whose dot product with $\mathbf{c}$
decrypts it.</p><p>Usually a larger key basis is undesirable. For one, operations in a higher key
basis are more expensive and have higher rates of noise growth. Repeated
multiplications exponentially increase the length of the key basis. So to avoid
this, an operation called <em>relinearization</em> was designed that converts a
ciphertext from a given key basis back to $(1, s)$. Doing this requires a set of
<em>relinearization keys</em> to be provided by the client and stored by the server.</p><p>In general, key bases can be arbitrary. Rotation of an RLWE ciphertext by a
shift of $k$, for example, first applies the automorphism $x \mapsto x^k$. This
converts the key basis from $(1, s)$ to $(1, s^k)$, and more generally maps $(1,
s, s^2, \dots, s^d) \mapsto (1, s^k, s^{2k}, \dots, s^{kd})$. Most FHE
implementations post-compose this automorphism with a key switching operation to
return to the linear basis $(1, s)$. Similarly, multiplication can be defined
for two key bases $(1, s^n)$ and $(1, s^m)$ (with $n &lt; m$) to produce a key
basis $(1, s^n, s^m, s^{n+m})$. By a combination of multiplications and
rotations (without ever relinearizing or key switching), ciphertexts with a
variety of strange key bases can be produced.</p><p>Most FHE implementations do not permit wild key bases because each key switch
and relinearization operation (for each choice of key basis) requires additional
secret key material to be stored by the server. Instead, they often enforce that
rotation has key-switching built in, and multiplication relinearizes by default.</p><p>That said, many FHE implementations do allow for the relinearization operation
to be deferred. A useful such situation is when a series of independent
multiplications are performed, and the results are added together. Addition can
operate in any key basis (though depending on the backend FHE implementation&rsquo;s
details, all inputs may require the same key basis, cf.
<a href=#optional-operand-agreement>Optional operand agreement</a>), and so the
relinearization op that follows each multiplication can be deferred until after
the additions are complete, at which point there is only one relinearization to
perform. This technique is usually called <em>lazy relinearization</em>. It has the
benefit of avoiding expensive relinearization operations, as well as reducing
noise growth, as relinearization adds noise to the ciphertext, which can further
reduce the need for bootstrapping.</p><p>In much of the literature, lazy relinearization is applied manually. See for
example
<a href=https://eprint.iacr.org/2019/223>Blatt-Gusev-Polyakov-Rohloff-Vaikuntanathan 2019</a>
and <a href=https://eprint.iacr.org/2020/1549>Lee-Lee-Kim-Kim-No-Kang 2020</a>. In some
compiler projects, such as the <a href=https://eprint.iacr.org/2021/1505>EVA compiler</a>
relinearization is applied automatically via a heuristic, either &ldquo;eagerly&rdquo;
(immediately after each multiplication op) or &ldquo;lazily,&rdquo; deferred as late as
possible.</p><h2 id=the-optimize-relinearization-pass>The <code>optimize-relinearization</code> pass</h2><p>In HEIR, relinearization placement is implemented via a mixed-integer linear
program (ILP). It is intended to be more general than a lazy relinearization
heuristic, and certain parameter settings of the ILP reproduce lazy
relinearization.</p><p>The <code>optimize-relinearization</code> pass starts by deleting all relinearization
operations from the IR, solves the ILP, and then inserts relinearization ops
according to the solution. This implies that the input IR to the ILP has no
relinearization ops in it already.</p><h2 id=model-specification>Model specification</h2><p>The ILP model fits into a family of models that is sometimes called
&ldquo;state-dynamics&rdquo; models, in that it has &ldquo;state&rdquo; variables that track a quantity
that flows through a system, as well as &ldquo;decision&rdquo; variables that control
decisions to change the state at particular points. A brief overview of state
dynamics models can be found
<a href=https://buttondown.com/j2kun/archive/modeling-state-in-linear-programs/>here</a></p><p>In this ILP, the &ldquo;state&rdquo; value is the degree of the key basis. I.e., rather than
track the entire key basis, we assume the key basis always has the form $(1, s,
s^2, \dots, s^k)$ and track the value $k$. The index tracking state is SSA
value, and the decision variables are whether to relinearize.</p><h3 id=variables>Variables</h3><p>Define the following variables:</p><ul><li>For each operation $o$, $R_o \in { 0, 1 }$ defines the decision to
relinearize the result of operation $o$. Relinearization is applied if and
only if $R_o = 1$.</li><li>For each SSA value $v$, $\textup{KB}_v$ is a continuous variable
representing the degree of the key basis of $v$. For example, if the key basis
of a ciphertext is $(1, s)$, then $\textup{KB}_v = 1$. If $v$ is the result
of an operation $o$, $\textup{KB}_v$ is the key basis of the result of $o$
<em>after</em> relinearization has been optionally applied to it, depending on the
value of the decision variable $R_o$.</li><li>For each SSA value $v$ that is an operation result, $\textup{KB}^{br}_v$ is
a continuous variable whose value represents the key basis degree of $v$
<em>before</em> relinearization is applied (<code>br</code> = &ldquo;before relin&rdquo;). These SSA values
are mainly for <em>after</em> the model is solved and relinearization operations need
to be inserted into the IR. Here, type conflicts require us to reconstruct the
key basis degree, and saving the values allows us to avoid recomputing the
values.</li></ul><p>Each of the key-basis variables is bounded from above by a parameter
<code>MAX_KEY_BASIS_DEGREE</code> that can be used to impose hard limits on the key basis
size, which may be required if generating code for a backend that does not
support operations over generalized key bases.</p><h3 id=objective>Objective</h3><p>The objective is to minimize the number of relinearization operations, i.e.,
$\min \sum_o R_o$.</p><p>TODO(#1018): update docs when objective is generalized.</p><h3 id=constraints>Constraints</h3><h4 id=simple-constraints>Simple constraints</h4><p>The simple constraints are as follows:</p><ul><li>Initial key basis degree: For each block argument, $\textup{KB}_v$ is fixed
to equal the <code>dimension</code> parameter on the RLWE ciphertext type.</li><li>Special linearized ops: <code>bgv.rotate</code> and <code>func.return</code> require linearized
inputs, i.e., $\textup{KB}_{v_i} = 1$ for all inputs $v_i$ to these
operations.</li><li>Before relinearization key basis: for each operation $o$ with operands $v_1,
\dots, v_k$, constrain $\textup{KB}^{br}_{\textup{result}(o)} =
f(\textup{KB}_{v_1}, \dots, \textup{KB}_{v_k})$, where $f$ is a
statically known linear function. For multiplication $f$ it addition, and for
all other ops it is the projection onto any input, since multiplication is the
only op that increases the degree, and all operands are constrained to have
equal degree.</li></ul><h4 id=optional-operand-agreement>Optional operand agreement</h4><p>There are two versions of the model, one where the an operation requires the
input key basis degrees of each operand to be equal, and one where differing key
basis degrees are allowed.</p><p>This is an option because the model was originally implemented under the
incorrect assumption that CPU backends like OpenFHE and Lattigo require the key
basis degree operands to be equal for ops like ciphertext addition. When we
discovered this was not the case, we generalized the model to support both
cases, in case other backends do have this requirement.</p><p>When operands must have the same key basis degree, then for each operation with
operand SSA values $v_1, \dots, v_k$, we add the constraint
$\textup{KB}_{v_1} = \dots = \textup{KB}_{v_k}$, i.e., all key basis inputs
must match.</p><p>When operands may have different key basis degrees, we instead add the
constraint that each operation result key basis degree (before relinearization)
is at least as large as the max of all operand key basis degrees. For all $i$,
$\textup{KB}_{\textup{result}(o)}^{br} \geq \textup{KB}_{v_i}$. Note that
we are relying on an implicit behavior of the model to ensure that, even if the
solver chooses key basis degree variables for these op results larger than the
max of the operand degrees, the resulting optimal solution is the same.</p><p>TODO(#1018): this will change to a more principled approach when the objective
is generalized</p><h4 id=impact-of-relinearization-choices-on-key-basis-degree>Impact of relinearization choices on key basis degree</h4><p>The remaining constraints control the dynamics of how the key basis degree
changes as relinearizations are inserted.</p><p>They can be thought of as implementing this (non-linear) constraint for each
operation $o$:</p><p>\[ \textup{KB}_{\textup{result}(o)} = \begin{cases}
\textup{KB}^{br}_{\textup{result(o)}} & \text{ if } R_o = 0 \\ 1 & \text{
if } R_o = 1 \end{cases} \]</p><p>Note that $\textup{KB}^{br}_{\textup{result}(o)}$ is constrained by one of
the simple constraints to be a linear expression containing key basis variables
for the operands of $o$. The conditional above cannot be implemented directly in
an ILP. Instead, one can implement it via four constraints that effectively
linearize (in the sense of making non-linear constraints linear) the multiplexer
formula</p><p>\[ \textup{KB}_{\textup{result}(o)} = (1 - R_o) \cdot
\textup{KB}^{br}_{\textup{result}(o)} + R_o \cdot 1 \]</p><p>(Note the above is not linear because in includes the product of two variables.)
The four constraints are:</p><p>\[ \begin{aligned} \textup{KB}_\textup{result}(o) &\geq \textup{ R}_o
\\
\textup{KB}_\textup{result}(o) &\leq 1 + C(1 – \textup{R}_o)
\\
\textup{KB}_\textup{result}(o) &\geq
\textup{KB}^{br}_{\textup{result}(o)} – C \textup{ R}_o
\\
\textup{KB}_\textup{result}(o) &\leq
\textup{KB}^{br}_{\textup{result}(o)} + C \textup{ R}_o \\
\end{aligned}
\]</p><p>Here $C$ is a constant that can be set to any value larger than
<code>MAX_KEY_BASIS_DEGREE</code>. We set it to 100.</p><p>Setting $R_o = 0$ makes constraints 1 and 2 trivially satisfied, while
constraints 3 and 4 enforce the equality $\textup{KB}_{\textup{result}(o)} =
\textup{KB}^{br}_{\textup{result}(o)}$. Likewise, setting $R_o = 1$ makes
constraints 3 and 4 trivially satisfied, while constraints 1 and 2 enforce the
equality $\textup{KB}_{\textup{result}(o)} = 1$.</p><h2 id=notes>Notes</h2><ul><li>ILP performance scales roughly with the number of integer variables. The
formulation above only requires the decision variable to be integer, and the
initialization and constraints effectively force the key basis variables to be
integer. As a result, the solve time of the above ILP should scale with the
number of ciphertext-handling ops in the program.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-db9ac78ce08367ea2b7db8c1412049b6>6 - Pipelines</h1><h2 id=heir-opt><code>heir-opt</code></h2><h3 id=--heir-simd-vectorizer><code>--heir-simd-vectorizer</code></h3><p>Run scheme-agnostic passes to convert FHE programs that operate on scalar types
to equivalent programs that operate on vectors.</p><p>This pass is intended to process FHE programs that are known to be good for
SIMD, but a specific FHE scheme has not yet been chosen. It expects to handle
<code>arith</code> ops operating on <code>tensor</code> types (with or without <code>secret.generic</code>).</p><p>The pass unrolls all loops, then applies a series of passes that convert scalar
operations on tensor elements to SIMD operations on full tensors. This uses the
FHE computational model common to BGV, BFV, and CKKS, in which data is packed in
polynomial ciphertexts, interpreted as vectors of individual data elements, and
arithmetic can be applied across entire ciphertexts, with some limited support
for rotations via automorphisms of the underlying ring.</p><p>Along the way, this pipeline applies heuristic optimizations to minimize the
number of rotations needed, relying on the implicit cost model that rotations
are generally expensive. The specific set of passes can be found in
<code>tools/heir-opt.cpp</code> where the pipeline is defined.</p><h3 id=--heir-tosa-to-arith><code>--heir-tosa-to-arith</code></h3><p>Lowers a TOSA MLIR model to <code>func</code>, <code>arith</code>, and <code>memref</code>.</p><p>Lowers from TOSA through <code>linalg</code> and <code>affine</code>, and converts all tensors to
memrefs. Fully unrolls all loops, and forwards stores to subsequent loads
whenever possible. The output is suitable as an input to
<code>heir-translate --emit-verilog</code>. Retains <code>affine.load</code> and <code>affine.store</code> ops
that cannot be removed (e.g., reading from the input and writing to the output,
or loading from a memref with a variable index).</p><p>The pass pipeline assumes that the input is a valid TOSA MLIR model with
stripped quantized types. The
<a href=https://iree.dev/guides/ml-frameworks/tflite>iree-import-tflite</a> tool can
lower a TFLite FlatBuffer to textual MLIR with <code>--output-format=mlir-ir</code>. See
<a href=https://github.com/google/heir/blob/main/tests/Emitter/verilog/hello_world.tosa.mlir>hello_world.tosa.mlir</a>
for an example.</p><h3 id=--yosys-optimizer><code>--yosys-optimizer</code></h3><p>Uses Yosys to booleanize and optimize MLIR functions.</p><p>This pass pipeline requires inputs to be in standard MLIR (<code>arith</code>, <code>affine</code>,
<code>func</code>, <code>memref</code>). The pass imports the model to Yosys and runs passes to
booleanize the circuit and then uses ABC to perform optimizations. We use
standard LUT 3 cells. THe output of this pass includes <code>arith</code> constants and
<code>comb.truth_table</code> ops.</p><p>The pass requires that the environment variable <code>HEIR_ABC_BINARY</code> contains the
location of the ABC binary and that <code>HEIR_YOSYS_SCRIPTS_DIR</code> contains the
location of the Yosys&rsquo; techlib files that are needed to execute the path.</p><p>This pass can be disabled by defining <code>HEIR_NO_YOSYS</code>; this will avoid Yosys
library and ABC binary compilation, and avoid registration of this pass.</p><h3 id=--tosa-to-boolean-tfhe><code>--tosa-to-boolean-tfhe</code></h3><p>This is an experimental pipeline for end-to-end private inference.</p><p>Converts a TOSA MLIR model to tfhe_rust dialect defined by HEIR. It converts a
tosa model to optimized boolean circuit using Yosys ABC optimizations. The
resultant optimized boolean circuit in comb dialect is then converted to cggi
and then to tfhe_rust exit dialect. This pipeline can be used with
heir-translate &ndash;emit-tfhe-rust to generate code for
<a href=https://docs.zama.ai/tfhe-rs><code>tfhe-rs</code></a> FHE library.</p><p>The pass requires that the environment variable <code>HEIR_ABC_BINARY</code> contains the
location of the ABC binary and that <code>HEIR_YOSYS_SCRIPTS_DIR</code> contains the
location of the Yosys&rsquo; techlib files that are needed to execute the path.</p><h2 id=heir-translate><code>heir-translate</code></h2><h3 id=--emit-tfhe-rust><code>--emit-tfhe-rust</code></h3><p>Code generation for the <a href=https://docs.zama.ai/tfhe-rs><code>tfhe-rs</code></a> FHE library.
The library is based on the CGGI cryptosystem, and so this pass is most useful
when paired with lowerings from the <code>cggi</code> dialect.</p><p>The version of <code>tfhe-rs</code> supported is defined in the
<a href=https://github.com/google/heir/tree/main/tests/Examples/tfhe_rust/Cargo.toml>end to end <code>tfhe_rust</code> tests</a>.</p><p>Example input:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span><span style=color:#000;font-weight:700>!</span><span style=color:#f57900>sks =</span> <span style=color:#000;font-weight:700>!</span>tfhe_rust<span style=color:#000;font-weight:700>.</span>server_key
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>!</span><span style=color:#f57900>lut =</span> <span style=color:#000;font-weight:700>!</span>tfhe_rust<span style=color:#000;font-weight:700>.</span>lookup_table
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>!</span><span style=color:#f57900>eui3 =</span> <span style=color:#000;font-weight:700>!</span>tfhe_rust<span style=color:#000;font-weight:700>.</span>eui3
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@test_apply_lookup_table</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%sks</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>sks<span style=color:#000;font-weight:700>,</span> <span style=color:#000>%lut</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>lut<span style=color:#000;font-weight:700>,</span> <span style=color:#000>%input</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>eui3<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>eui3 <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>%v1</span> <span style=color:#000;font-weight:700>=</span> tfhe_rust<span style=color:#000;font-weight:700>.</span>apply_lookup_table <span style=color:#000>%sks</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%input</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%lut</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>(!</span>sks<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>!</span>eui3<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>!</span>lut<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>eui3
</span></span><span style=display:flex><span>  <span style=color:#000>%v2</span> <span style=color:#000;font-weight:700>=</span> tfhe_rust<span style=color:#000;font-weight:700>.</span>add <span style=color:#000>%sks</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%input</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%v1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>(!</span>sks<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>!</span>eui3<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>!</span>eui3<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>eui3
</span></span><span style=display:flex><span>  <span style=color:#000>%v3</span> <span style=color:#000;font-weight:700>=</span> tfhe_rust<span style=color:#000;font-weight:700>.</span>scalar_left_shift <span style=color:#000>%sks</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%v2</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>shiftAmount =</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>index</span><span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>(!</span>sks<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>!</span>eui3<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>eui3
</span></span><span style=display:flex><span>  <span style=color:#000>%v4</span> <span style=color:#000;font-weight:700>=</span> tfhe_rust<span style=color:#000;font-weight:700>.</span>apply_lookup_table <span style=color:#000>%sks</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%v3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%lut</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>(!</span>sks<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>!</span>eui3<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>!</span>lut<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>!</span>eui3
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>%v4</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>!</span>eui3
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>Example output:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#204a87;font-weight:700>use</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tfhe</span>::<span style=color:#000>shortint</span>::<span style=color:#000>prelude</span>::<span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>pub</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>test_apply_lookup_table</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>v9</span>: <span style=color:#204a87;font-weight:700>&amp;</span><span style=color:#000>ServerKey</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>v10</span>: <span style=color:#204a87;font-weight:700>&amp;</span><span style=color:#000>LookupTableOwned</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>v11</span>: <span style=color:#204a87;font-weight:700>&amp;</span><span style=color:#000>Ciphertext</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>Ciphertext</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v4</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v9</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>apply_lookup_table</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>v11</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>v10</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v5</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v9</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>unchecked_add</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>v11</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>v4</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v6</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v7</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v9</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>scalar_left_shift</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>v5</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v6</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v8</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v9</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>apply_lookup_table</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>v7</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>v10</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>v8</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Note, the chosen variable names are arbitrary, and the resulting program still
must be integrated with a larger Rust program.</p><h3 id=--emit-verilog><code>--emit-verilog</code></h3><p>Code generation for verilog from <code>arith</code> and <code>memref</code>. Expects a single top
level <code>func.func</code> op as the entry point, which is converted to the output
verilog module.</p><p>Example input:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span>module <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@main</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i8</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>i8</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%c0</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%c1</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%c2</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%c3</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>constant</span> <span style=color:#0000cf;font-weight:700>3</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%0</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>extsi <span style=color:#000>%arg0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i8</span> to <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%1</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>subi <span style=color:#000>%0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%2</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>muli <span style=color:#000>%1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c2</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%3</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>addi <span style=color:#000>%2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c3</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%4</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>cmpi sge<span style=color:#000;font-weight:700>,</span> <span style=color:#000>%2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%5</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>select <span style=color:#000>%4</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c2</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%6</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>shrsi <span style=color:#000>%3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%7</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>shrui <span style=color:#000>%3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>%c1</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%out</span> <span style=color:#000;font-weight:700>=</span> arith<span style=color:#000;font-weight:700>.</span>trunci <span style=color:#000>%6</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i32</span> to <span style=color:#204a87;font-weight:700>i8</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>%out</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i8</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>Output:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#204a87;font-weight:700>module</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>input</span> <span style=color:#204a87;font-weight:700>wire</span> <span style=color:#204a87;font-weight:700>signed</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000>arg1</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>output</span> <span style=color:#204a87;font-weight:700>wire</span> <span style=color:#204a87;font-weight:700>signed</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000>_out_</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>wire</span> <span style=color:#204a87;font-weight:700>signed</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>31</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000>v2</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>wire</span> <span style=color:#204a87;font-weight:700>signed</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>31</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000>v3</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>wire</span> <span style=color:#204a87;font-weight:700>signed</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>31</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000>v4</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>wire</span> <span style=color:#204a87;font-weight:700>signed</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>31</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000>v5</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>wire</span> <span style=color:#204a87;font-weight:700>signed</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>31</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000>v6</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>wire</span> <span style=color:#204a87;font-weight:700>signed</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>31</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000>v7</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>wire</span> <span style=color:#204a87;font-weight:700>signed</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>31</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000>v8</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>wire</span> <span style=color:#204a87;font-weight:700>signed</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>31</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000>v9</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>wire</span> <span style=color:#000>v10</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>wire</span> <span style=color:#204a87;font-weight:700>signed</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>31</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000>v11</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>wire</span> <span style=color:#204a87;font-weight:700>signed</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>31</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000>v12</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>wire</span> <span style=color:#204a87;font-weight:700>signed</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>31</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000>v13</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>wire</span> <span style=color:#204a87;font-weight:700>signed</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000>v14</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>assign</span> <span style=color:#000>v2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>assign</span> <span style=color:#000>v3</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>assign</span> <span style=color:#000>v4</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>assign</span> <span style=color:#000>v5</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>assign</span> <span style=color:#000>v6</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{{</span><span style=color:#0000cf;font-weight:700>24</span><span style=color:#000;font-weight:700>{</span><span style=color:#000>arg1</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#000;font-weight:700>]}},</span> <span style=color:#000>arg1</span><span style=color:#000;font-weight:700>};</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>assign</span> <span style=color:#000>v7</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>v6</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>v3</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>assign</span> <span style=color:#000>v8</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>v7</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>v4</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>assign</span> <span style=color:#000>v9</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>v8</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>v5</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>assign</span> <span style=color:#000>v10</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>v8</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>v2</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>assign</span> <span style=color:#000>v11</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>v10</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>v3</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>v4</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>assign</span> <span style=color:#000>v12</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>v9</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000>v3</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>assign</span> <span style=color:#000>v13</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>v9</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>v3</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>assign</span> <span style=color:#000>v14</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>v12</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>];</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>assign</span> <span style=color:#000>_out_</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>v14</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>endmodule</span>
</span></span></code></pre></div><h3 id=--emit-metadata><code>--emit-metadata</code></h3><p>Prints a json object describing the function signatures. Used for code
generation after <code>--emit-verilog</code>.</p><p>Example input:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mlir data-lang=mlir><span style=display:flex><span>module <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>@main</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>%arg0</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>memref</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>80x</span><span style=color:#204a87;font-weight:700>i8</span><span style=color:#000;font-weight:700>&gt;)</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#204a87;font-weight:700>memref</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>1x3x2x1x</span><span style=color:#204a87;font-weight:700>i8</span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>%alloc_0</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>memref</span><span style=color:#000;font-weight:700>.</span>alloc<span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f57900>alignment =</span> <span style=color:#0000cf;font-weight:700>64</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>i64</span><span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>memref</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>1x3x2x1x</span><span style=color:#204a87;font-weight:700>i8</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>%alloc_0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>memref</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#0000cf;font-weight:700>1x3x2x1x</span><span style=color:#204a87;font-weight:700>i8</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>Example output:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;functions&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;main&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&#34;params&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&#34;index&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&#34;type&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&#34;memref&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>              <span style=color:#204a87;font-weight:700>&#34;element_type&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&#34;integer&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                  <span style=color:#204a87;font-weight:700>&#34;is_signed&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                  <span style=color:#204a87;font-weight:700>&#34;width&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>8</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>              <span style=color:#000;font-weight:700>},</span>
</span></span><span style=display:flex><span>              <span style=color:#204a87;font-weight:700>&#34;shape&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>80</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>          <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>],</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&#34;return_types&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&#34;memref&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&#34;element_type&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&#34;integer&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>              <span style=color:#204a87;font-weight:700>&#34;is_signed&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#204a87;font-weight:700>&#34;width&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>8</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>          <span style=color:#000;font-weight:700>},</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&#34;shape&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>}]</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-590f1588f601079eeacfc7cb11dc5115>7 - Dialects</h1><p>This section contains the reference documentation for all of the dialects
defined in HEIR.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-19aafd690c3a7edde7a9c3e1fbaf737f>8 - Passes</h1></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-end text-xs-center order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/google/heir aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__copyright-etc col-12 col-sm-4 text-center py-2 order-sm-2"><span>&copy; 2025 The HEIR Authors All Rights Reserved</span>
<span class=ms-1><a href=https://policies.google.com/privacy target=_blank rel=noopener>Privacy Policy</a></span></div></div></div></footer></div><script src=/js/main.min.027d75d71824837bee74c12a7806c5fe51249c1ca7accc27553a251a75cdb3a4.js integrity="sha256-An111xgkg3vudMEqeAbF/lEknBynrMwnVTolGnXNs6Q=" crossorigin=anonymous></script>
<script defer src=/js/click-to-copy.min.f724d3de49218995223b7316aa2e53e2b34bf42026bf399ebb21bb02212402d1.js integrity="sha256-9yTT3kkhiZUiO3MWqi5T4rNL9CAmvzmeuyG7AiEkAtE=" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script></body></html>